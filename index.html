<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Caculator</title>
  <style>
    /* Bất kỳ phần tử có thuộc tính hidden đều ẩn tuyệt đối */
    [hidden] { display: none !important; }

    /* Nền tảng chung */
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f8ff; color: #222; }

    /* App hiển thị ngang (2 cột) khi KHÔNG hidden */
    #app { display: flex; gap: 30px; align-items: flex-start; }
    #app[hidden] { display: none !important; }

    .container { width: 48%; background: white; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.1); padding: 20px 25px; box-sizing: border-box; }
    h2, h3 { margin-bottom: 15px; color: #004080; border-bottom: 2px solid #0080ff; padding-bottom: 5px; }
    label { font-weight: 600; display: block; margin-top: 15px; margin-bottom: 5px; color: #003366; }
    input[type="text"], input[type="number"], textarea { width: 100%; padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; font-family: monospace; font-size: 14px; box-sizing: border-box; transition: border-color 0.3s ease; }
    input[type="text"]:focus, input[type="number"]:focus, textarea:focus { border-color: #3399ff; outline: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-family: monospace; font-size: 15px; }
    table th, table td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; color: #004080; }
    table th { background-color: #e6f0ff; }
    table input { border: none; text-align: center; font-weight: bold; font-size: 14px; width: 100%; padding: 4px 0; background: transparent; color: #00264d; }
    table input:focus { outline: 1px solid #3399ff; background: #dbe9ff; }
    .btn { background-color: #007bff; color: white; border: none; border-radius: 6px; padding: 10px 18px; font-size: 15px; cursor: pointer; margin-top: 15px; margin-right: 10px; transition: background-color 0.3s ease; user-select: none; }
    .btn:hover { background-color: #0056b3; }
    .btn-red { background-color: #dc3545; float: right; margin: 0 0 15px 0; }
    .btn-red:hover { background-color: #a61b2b; }
    .log { margin-top: 15px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 6px; padding: 12px 15px; font-family: monospace; font-size: 14px; min-height: 120px; white-space: pre-wrap; color: #222; }
    .history, #doneList { max-height: 480px; overflow-y: auto; border: 1px solid #ccc; background: #fafafa; border-radius: 6px; padding: 10px 12px; font-family: monospace; font-size: 14px; color: #111; }
    .history-entry { border-bottom: 1px solid #ccc; padding: 10px 8px; margin-bottom: 10px; background: #fff; border-radius: 5px; }
    .history-entry:last-child { margin-bottom: 0; }
    .entry-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; gap: 8px; }
    .entry-header input[type="text"] { flex: 1; min-width: 160px; padding: 6px 10px; font-size: 14px; border-radius: 4px; border: 1px solid #aaa; font-family: inherit; color: #003366; }
    .entry-header span { color: #004080; font-weight: 600; font-size: 14px; user-select: none; white-space: nowrap; }
    .entry-header button { margin-left: 0; border-radius: 5px; font-size: 13px; padding: 6px 10px; border: none; cursor: pointer; user-select: none; transition: background-color 0.3s ease; }
    .delete-btn { background-color: #dc3545; color: white; } .delete-btn:hover { background-color: #a61b2b; }
    .done-btn { background-color: #28a745; color: white; } .done-btn:hover { background-color: #1e7e34; }
    .edit-btn { background-color: #ffc107; color: #222; } .edit-btn:hover { background-color: #e0a800; }
    .save-btn { background-color: #007bff; color: white; } .save-btn:hover { background-color: #0056b3; }
    .cancel-btn { background-color: #6c757d; color: white; } .cancel-btn:hover { background-color: #565e64; }
    .entry-content div { display: flex; align-items: center; margin-bottom: 4px; }
    .entry-content div span { user-select: text; }
    .entry-content div input[type="checkbox"] { margin-right: 8px; cursor: pointer; transform: scale(1.1); }
    .highlighted { background-color: #d3f4d3; font-weight: bold; }
    .done-entry { border-left: 4px solid #28a745; background-color: #e6f7e6 !important; font-weight: bold !important; color: #155724 !important; }
    .history::-webkit-scrollbar, #doneList::-webkit-scrollbar { width: 8px; }
    .history::-webkit-scrollbar-thumb, #doneList::-webkit-scrollbar-thumb { background-color: #b0c4de; border-radius: 4px; }
    .btn-container { margin-top: 15px; overflow: hidden; }

    .sync-badge { position: fixed; right: 16px; top: 12px; background:#eee; color:#333; border-radius:16px; padding:6px 10px; font:600 12px/1.2 system-ui,Arial; box-shadow:0 1px 3px rgba(0,0,0,.1); z-index: 9999; }
    .sync-ok { background:#e6ffed; color:#056e1a; }
    .sync-warn { background:#fff2e6; color:#8a4b00; }
    .sync-err { background:#ffe6e6; color:#7a1414; }

    /* Login card */
    .auth-wrap { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: #f0f8ff; }
    .auth-card { width: 360px; max-width: 92vw; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.1); padding: 20px; }
    .auth-card h2 { margin: 0 0 12px; border: none; color: #0b4aa7; }
    .auth-card .row { margin-bottom: 10px; }
    .auth-card input { width: 100%; padding: 10px 12px; border: 1px solid #cdd6e0; border-radius: 8px; font-size: 14px; }
    .auth-card button { width: 100%; padding: 10px 12px; border: none; border-radius: 8px; background: #0b73ff; color: #fff; font-weight: 600; cursor: pointer; }
    .auth-msg { margin-top: 8px; font-size: 13px; color: #a11; min-height: 18px; }
    .topbar { position: fixed; left: 16px; top: 12px; display: flex; gap: 8px; align-items: center; z-index: 9999; }
    .logout { background:#444; color:#fff; border:none; border-radius:16px; padding:6px 10px; font:600 12px/1.2 system-ui; cursor:pointer; }

    /* Responsive: chỉ xếp dọc khi màn hình hẹp */
    @media (max-width: 768px){
      #app { flex-direction: column; }
      .container { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- trạng thái + logout -->
  <div class="topbar">
    <button id="logoutBtn" class="logout" hidden>Đăng xuất</button>
  </div>
  <div class="sync-badge sync-warn" id="syncStatus" title="Tự lưu cục bộ. Đăng nhập để đồng bộ realtime.">Sync: Local only</div>

  <!-- màn đăng nhập -->
  <div id="loginWrap" class="auth-wrap">
    <div class="auth-card">
      <h2>Đăng nhập</h2>
      <div class="row"><input id="email" type="email" placeholder="Email" autocomplete="username" /></div>
      <div class="row"><input id="password" type="password" placeholder="Mật khẩu" autocomplete="current-password" /></div>
      <button id="loginBtn">Đăng nhập</button>
      <div id="loginMsg" class="auth-msg"></div>
      <div style="font-size:12px;color:#666;margin-top:6px">Tài khoản do admin cấp. Không mở đăng ký.</div>
    </div>
  </div>

  <!-- ứng dụng chính: thêm style="display:none" để chắc chắn ẩn trước khi đăng nhập -->
  <div id="app" hidden style="display:none">
    <div class="container">
      <h2>Caculator</h2>
      <label>Tỷ giá (IDR / U / ABA):</label>
      <table>
        <thead><tr><th>Loại</th><th>Tỷ giá</th></tr></thead>
        <tbody>
          <tr><td>IDR / U</td><td><input type="number" id="rateU" placeholder="U" oninput="calculate()" /></td></tr>
          <tr><td>IDR / ABA</td><td><input type="number" id="rateABA" placeholder="ABA" oninput="calculate()" /></td></tr>
        </tbody>
      </table>
      <label>USDT:</label>
      <input type="text" id="usdt_input" placeholder="Ví dụ: 1k, 1.2k, 1350.5" oninput="calculate()">
      <label>ABA:</label>
      <input type="text" id="aba_input" placeholder="Ví dụ: 2k, 5000" oninput="calculate()">
      <label>IDR ➝ USDT:</label>
      <input type="number" id="idr_usdt_input" placeholder="Nhập số IDR để đổi USDT" oninput="calculate()">
      <label>IDR ➝ ABA:</label>
      <input type="number" id="idr_aba_input" placeholder="Nhập số IDR để đổi ABA" oninput="calculate()">
      <div class="btn-container">
        <button class="btn" onclick="copyForm()">Copy Form</button>
        <button class="btn" onclick="addToHistory()">Add vào lịch sử</button>
      </div>
      <div class="log" id="log"></div>
    </div>

    <div class="container">
      <h3>Lịch sử
        <button class="btn btn-red" style="float:right;" onclick="clearHistory()">Xóa toàn bộ lịch sử</button>
      </h3>
      <div class="history" id="history"></div>

      <h3>Đã xong</h3>
      <div id="doneList"></div>
    </div>
  </div>

  <!-- ====== JS gốc: tính toán & UI local ====== -->
  <script>
    function parseInput(value) {
      value = value.toLowerCase().trim();
      if (value.includes('k')) { value = value.replace(',', '.').replace('k', ''); return parseFloat(value) * 1000; }
      return parseFloat(value.replace(/,/g, ''));
    }
    function formatIDR(num) { return Math.round(num).toLocaleString('de-DE').replace(/\./g, ','); }
    function formatCurrencyVN(num) { const rounded = Math.round(num * 100) / 100; return Number.isInteger(rounded) ? rounded.toLocaleString('de-DE').replace(/\./g, ',') : rounded.toString(); }
    function formatSmartDecimal(num) { const r = Math.round(num * 100) / 100; return Number.isInteger(r) ? r.toLocaleString('en-US',{minimumFractionDigits:0}) : r.toLocaleString('en-US',{maximumFractionDigits:2,minimumFractionDigits:2}); }
    function getRates() { const rateU = parseFloat(document.getElementById('rateU').value); const rateABA = parseFloat(document.getElementById('rateABA').value); return { rateU, rateABA }; }
    function getToday() { const d = new Date(); return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`; }
    function getCurrentTime() { const d = new Date(); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
    function calculate() {
      const { rateU, rateABA } = getRates();
      const usdtVal = document.getElementById('usdt_input').value;
      const abaVal = document.getElementById('aba_input').value;
      const idrUsdtRaw = document.getElementById('idr_usdt_input').value.trim();
      const idrAbaRaw = document.getElementById('idr_aba_input').value.trim();
      let log = '', today = getToday();
      if (!rateU && !rateABA) { document.getElementById("log").innerText = "Không tìm thấy tỷ giá."; return; }
      if (usdtVal) {
        const usdt = parseInput(usdtVal);
        if (!isNaN(usdt) && rateU) { const fee = usdt < 5000 ? 7 : 0; const total = usdt + fee; const idr = total * rateU;
          log += `${today}\nUSDT: ${formatCurrencyVN(usdt)}${fee>0?` + ${fee} (fee)`:''} @ ${rateU}\nIDR: ${formatIDR(idr)}\n\n`; }
      }
      if (abaVal) {
        const aba = parseInput(abaVal);
        if (!isNaN(aba) && rateABA) { const fee = aba < 5000 ? 10 : 0; const total = aba + fee; const idr = total * rateABA;
          log += `${today}\nABA: ${formatCurrencyVN(aba)}${fee>0?` + ${fee} (fee)`:''} @ ${rateABA}\nIDR: ${formatIDR(idr)}\n\n`; }
      }
      if (idrUsdtRaw && !isNaN(parseFloat(idrUsdtRaw)) && rateU) {
        const idr = parseFloat(idrUsdtRaw); const usdt = idr / rateU;
        log += `${today}:\nIDR: ${formatIDR(idr)} @ ${rateU}\nUSDT: ${formatSmartDecimal(usdt)}\n\n`;
      }
      if (idrAbaRaw && !isNaN(parseFloat(idrAbaRaw)) && rateABA) {
        const idr = parseFloat(idrAbaRaw); const aba = idr / rateABA;
        log += `${today}:\nIDR: ${formatIDR(idr)} @ ${rateABA}\nABA: ${formatSmartDecimal(aba)}\n\n`;
      }
      document.getElementById("log").innerText = log || "Không có dữ liệu.";
    }
    function copyForm() { const text = document.getElementById("log").innerText; if (text.trim()) navigator.clipboard.writeText(text).then(()=>alert("Đã sao chép.")); }
    function addToHistory() {
      const logText = document.getElementById("log").innerText.trim();
      if (!logText || logText === "Không có dữ liệu." || logText === "Không tìm thấy tỷ giá.") return;
      const entry = document.createElement("div"); entry.className = "history-entry";
      const header = document.createElement("div"); header.className = "entry-header";
      const name = document.createElement("input"); name.placeholder = "Tên giao dịch"; name.type = "text";
      const date = document.createElement("span"); date.textContent = `${getToday()} ${getCurrentTime()}`;
      const del = document.createElement("button"); del.textContent = "Xóa"; del.className = "delete-btn"; del.onclick = () => entry.remove();
      const doneBtn = document.createElement("button"); doneBtn.textContent = "Duyệt"; doneBtn.className = "done-btn"; doneBtn.onclick = () => markAsDone(entry);
      header.append(name,date,doneBtn,del);
      const content = document.createElement("div"); content.className = "entry-content"; content.style.marginTop = "8px";
      logText.split('\n').forEach(line => { if (!line.trim()) return;
        const lineContainer = document.createElement("div");
        const tick = document.createElement("input"); tick.type = "checkbox"; tick.style.marginRight = "8px";
        const span = document.createElement("span"); span.textContent = line;
        tick.addEventListener('change', () => { span.classList.toggle('highlighted', tick.checked); });
        lineContainer.append(tick, span); content.appendChild(lineContainer);
      });
      entry.append(header, content); document.getElementById("history").prepend(entry);
    }
    function markAsDone(entry) {
      entry.remove();
      const doneEntry = document.createElement("div"); doneEntry.className = "history-entry done-entry";
      const header = document.createElement("div"); header.className = "entry-header";
      const nameInput = document.createElement("input"); nameInput.type = "text"; nameInput.value = entry.querySelector('.entry-header input[type="text"]').value; nameInput.style.fontWeight="bold"; nameInput.style.color="#155724"; nameInput.readOnly = true;
      const editBtn = document.createElement("button"); editBtn.textContent = "Chỉnh sửa"; editBtn.className = "edit-btn";
      const content = document.createElement("textarea"); content.style.cssText = "width:100%;margin-top:8px;font-family:monospace;font-size:14px;border-radius:6px;border:1px solid #ccc;resize:vertical;display:none;"; content.value = getEntryContentText(entry);
      const contentDisplay = document.createElement("div"); contentDisplay.style.cssText="white-space:pre-wrap;color:#155724;font-weight:bold;margin-top:8px;"; contentDisplay.textContent = content.value;
      editBtn.onclick = () => {
        if (content.style.display === "none") { content.style.display = "block"; contentDisplay.style.display = "none"; editBtn.textContent = "Lưu"; nameInput.readOnly = false; nameInput.focus(); }
        else { content.style.display = "none"; contentDisplay.style.display = "block"; contentDisplay.textContent = content.value; editBtn.textContent = "Chỉnh sửa"; nameInput.readOnly = true; }
      };
      header.append(nameInput, editBtn); doneEntry.append(header, contentDisplay, content); document.getElementById("doneList").prepend(doneEntry);
    }
    function getEntryContentText(entry) { const lines = [...entry.querySelectorAll('.entry-content div span')].map(span => span.textContent); return lines.join('\n'); }
    function clearHistory() { if (confirm("Bạn có chắc muốn xóa toàn bộ lịch sử?")) { document.getElementById("history").innerHTML = ""; document.getElementById("doneList").innerHTML = ""; } }
  </script>

  <!-- ====== Auto-save localStorage ====== -->
  <script>
    (function(){
      const KEY='caculator_autosave_v1';
      const ids=['rateU','rateABA','usdt_input','aba_input','idr_usdt_input','idr_aba_input'];
      function save(){ try{
        const inputs={}; ids.forEach(id=>inputs[id]=(document.getElementById(id)?.value)||'');
        const state={ inputs, history: document.getElementById('history')?.innerHTML||'', done: document.getElementById('doneList')?.innerHTML||'', t: Date.now() };
        localStorage.setItem(KEY, JSON.stringify(state));
      }catch(e){} }
      function load(){ try{
        const raw=localStorage.getItem(KEY); if(!raw) return; const s=JSON.parse(raw);
        if(s.inputs){ ids.forEach(id=>{ const el=document.getElementById(id); if(el && s.inputs[id]!=null) el.value=s.inputs[id]; }); }
        if(typeof window.calculate==='function') window.calculate();
        if(s.history) document.getElementById('history').innerHTML=s.history;
        if(s.done) document.getElementById('doneList').innerHTML=s.done;
      }catch(e){} }
      load();
      ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('input', ()=>setTimeout(save,120)); });
      ['history','doneList'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('input', ()=>setTimeout(save,120)); el.addEventListener('click', ()=>setTimeout(save,120)); el.addEventListener('change', ()=>setTimeout(save,120)); } });
      const _add=window.addToHistory; if(typeof _add==='function') window.addToHistory=function(){ _add(); setTimeout(save,50); };
      const _done=window.markAsDone; if(typeof _done==='function') window.markAsDone=function(e){ _done(e); setTimeout(save,50); };
      const _clear=window.clearHistory; if(typeof _clear==='function') window.clearHistory=function(){ _clear(); setTimeout(save,50); };
      window.addEventListener('beforeunload', save);
    })();
  </script>

  <!-- ====== Firebase + Auth (Email/Password) ====== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDcyh6-XOKIS8GLCx24aAT5WPewc-Cu0RM",
      authDomain: "testsever1-1f5c9.firebaseapp.com",
      databaseURL: "https://testsever1-1f5c9-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "testsever1-1f5c9",
      storageBucket: "testsever1-1f5c9.firebasestorage.app",
      messagingSenderId: "587078219356",
      appId: "1:587078219356:web:5684169dcabbf85a0e9899"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);
    setPersistence(auth, browserLocalPersistence);

    const statusEl  = document.getElementById('syncStatus');
    const appEl     = document.getElementById('app');
    const loginWrap = document.getElementById('loginWrap');
    const loginBtn  = document.getElementById('loginBtn');
    const loginMsg  = document.getElementById('loginMsg');
    const emailEl   = document.getElementById('email');
    const passEl    = document.getElementById('password');
    const logoutBtn = document.getElementById('logoutBtn');

    const roomId = location.hash?.slice(1) || "global";
    let unsubEntries = null, unsubInputs = null;
    let editingKey = null;

    loginBtn.onclick = async () => {
      loginMsg.textContent = "";
      try {
        if (!emailEl.value || !passEl.value) { loginMsg.textContent = "Nhập email và mật khẩu."; return; }
        await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
      } catch (e) {
        loginMsg.textContent = e?.code?.replace("auth/","") || "Đăng nhập thất bại";
      }
    };
    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Hiện app
        loginWrap.style.display = "none";
        appEl.hidden = false;
        appEl.style.display = "flex";   // bỏ inline display:none
        logoutBtn.hidden = false;

        statusEl.textContent = "Sync: Realtime";
        statusEl.classList.remove('sync-warn','sync-err'); statusEl.classList.add('sync-ok');
        attachRealtime(user);
      } else {
        // Ẩn app
        detachRealtime();
        appEl.hidden = true;
        appEl.style.display = "none";   // đảm bảo ẩn
        logoutBtn.hidden = true;
        loginWrap.style.display = "flex";

        statusEl.textContent = "Sync: Local only";
        statusEl.classList.remove('sync-ok'); statusEl.classList.add('sync-warn');
      }
    });

    function detachRealtime(){
      if (typeof unsubEntries === 'function') { unsubEntries(); unsubEntries = null; }
      if (typeof unsubInputs  === 'function') { unsubInputs();  unsubInputs  = null; }
    }

    function attachRealtime(user){
      detachRealtime();

      const inputsRef  = ref(db, `users/${user.uid}/rooms/${roomId}/inputs`);
      const entriesRef = ref(db, `users/${user.uid}/rooms/${roomId}/entries`);

      // Sync inputs 2 chiều
      const ids=['rateU','rateABA','usdt_input','aba_input','idr_usdt_input','idr_aba_input'];
      let applyingRemote=false;
      function readInputs(){ const o={}; ids.forEach(id=>o[id]=document.getElementById(id)?.value||""); return o; }
      function saveInputs(){ if(applyingRemote) return; set(inputsRef, readInputs()); }
      ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('input', ()=>setTimeout(saveInputs,120)); });
      unsubInputs = onValue(inputsRef, snap => {
        const v=snap.val(); if(!v) return;
        applyingRemote=true;
        ids.forEach(id=>{ const el=document.getElementById(id); if(el && typeof v[id]!=='undefined' && el.value!==v[id]) el.value=v[id]??""; });
        applyingRemote=false;
        if(typeof window.calculate==='function') window.calculate();
      });

      // Lịch sử
      const historyEl=document.getElementById('history');
      const doneEl=document.getElementById('doneList');

      function renderAll(data){
        if (editingKey) return;
        historyEl.innerHTML=""; doneEl.innerHTML="";
        const arr = data ? Object.entries(data) : [];
        arr.sort((a,b)=>(b[1]?.createdAt||0)-(a[1]?.createdAt||0)); // mới nhất trước
        for(const [key,e] of arr){ (e.status==='done' ? makeDoneEntry : makeActiveEntry)(key,e); }
      }

      function makeActiveEntry(key,e){
        const entry=document.createElement("div"); entry.className="history-entry"; entry.dataset.key=key;
        const header=document.createElement("div"); header.className="entry-header";

        const name=document.createElement("input"); name.type="text"; name.placeholder="Tên giao dịch"; name.value=e.name||"";
        let tmr=null;
        name.addEventListener('focus', ()=>{ editingKey = key; });
        name.addEventListener('input', ()=>{
          editingKey = key; clearTimeout(tmr);
          tmr = setTimeout(()=>{ update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{name:name.value}); editingKey=null; }, 600);
        });
        name.addEventListener('blur', ()=>{
          clearTimeout(tmr); update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{name:name.value}); editingKey=null;
        });

        const date=document.createElement("span"); date.textContent=e.date||"";
        const doneBtn=document.createElement("button"); doneBtn.className="done-btn"; doneBtn.textContent="Duyệt";
        const del=document.createElement("button"); del.className="delete-btn"; del.textContent="Xóa";
        del.onclick=()=>remove(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`));
        doneBtn.onclick=()=>{
          const lines=[...entry.querySelectorAll('.entry-content span')].map(s=>s.textContent);
          update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{status:'done',name:name.value||"",content:(e.content||lines.join("\n"))});
        };
        header.append(name,date,doneBtn,del);

        const content=document.createElement("div"); content.className="entry-content"; content.style.marginTop="8px";
        (e.lines||[]).forEach((line,i)=>{
          if(!line?.trim()) return;
          const lineContainer=document.createElement("div");
          const tick=document.createElement("input"); tick.type="checkbox"; tick.style.marginRight="8px";
          const span=document.createElement("span"); span.textContent=line;
          tick.checked=!!(e.ticks&&e.ticks[i]); if(tick.checked) span.classList.add('highlighted');
          tick.addEventListener('change',()=>{
            const ticks=[]; content.querySelectorAll('input[type="checkbox"]').forEach(ch=>ticks.push(ch.checked));
            update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{ticks});
            span.classList.toggle('highlighted', tick.checked);
          });
          lineContainer.append(tick,span); content.appendChild(lineContainer);
        });

        entry.append(header,content);
        historyEl.appendChild(entry); // đã sort, append theo thứ tự
      }

      function makeDoneEntry(key,e){
        const entry=document.createElement("div"); entry.className="history-entry done-entry"; entry.dataset.key=key;
        const header=document.createElement("div"); header.className="entry-header";
        const nameInput=document.createElement("input"); nameInput.type="text"; nameInput.value=e.name||""; nameInput.style.fontWeight="bold"; nameInput.style.color="#155724"; nameInput.readOnly=true;
        const editBtn=document.createElement("button"); editBtn.className="edit-btn"; editBtn.textContent="Chỉnh sửa";
        const del=document.createElement("button"); del.className="delete-btn"; del.textContent="Xóa";
        del.onclick=()=>remove(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`));
        header.append(nameInput,editBtn,del);

        const textarea=document.createElement("textarea"); textarea.style.cssText="width:100%;margin-top:8px;font-family:monospace;font-size:14px;border-radius:6px;border:1px solid #ccc;resize:vertical;display:none;"; textarea.value=e.content||(e.lines||[]).join("\n");
        const display=document.createElement("div"); display.style.cssText="white-space:pre-wrap;color:#155724;font-weight:bold;margin-top:8px;"; display.textContent=textarea.value;

        editBtn.onclick=()=>{
          const editing=textarea.style.display==="block";
          if(!editing){ textarea.style.display="block"; display.style.display="none"; editBtn.textContent="Lưu"; nameInput.readOnly=false; nameInput.focus(); }
          else { textarea.style.display="none"; display.style.display="block"; display.textContent=textarea.value; editBtn.textContent="Chỉnh sửa"; nameInput.readOnly=true;
            update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{name:nameInput.value,content:textarea.value}); }
        };

        entry.append(header,display,textarea);
        doneEl.appendChild(entry);
      }

      // Ghi DB khi thêm lịch sử
      window.addToHistory = function(){
        const logText=document.getElementById("log").innerText.trim();
        if(!logText || logText==="Không có dữ liệu." || logText==="Không tìm thấy tỷ giá.") return;
        const lines=logText.split('\n').filter(l=>l.trim()!=="");
        push(ref(db,`users/${user.uid}/rooms/${roomId}/entries`), {
          name:"", date:`${getToday()} ${getCurrentTime()}`,
          lines, ticks:new Array(lines.length).fill(false),
          status:"active", createdAt:Date.now()
        });
      };
      window.clearHistory = function(){
        if(!confirm("Bạn có chắc muốn xóa toàn bộ lịch sử?")) return;
        set(ref(db,`users/${user.uid}/rooms/${roomId}/entries`), null);
      };

      unsubEntries = onValue(ref(db,`users/${user.uid}/rooms/${roomId}/entries`), snap => renderAll(snap.val()));
    }
  </script>
</body>
</html>
