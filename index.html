<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Caculator</title>
  <style>
    [hidden]{display:none!important}
    body{font-family:Arial,sans-serif;margin:20px;background:#f0f8ff;color:#222}
    #app,#appVI,#appTHB,#appABA{display:flex;gap:30px;align-items:flex-start}
    #app[hidden],#appVI[hidden],#appTHB[hidden],#appABA[hidden]{display:none!important}
    .container{width:48%;background:#fff;border-radius:8px;box-shadow:0 0 8px rgba(0,0,0,.1);padding:20px 25px;box-sizing:border-box}
    h2,h3{margin-bottom:15px;color:#004080;border-bottom:2px solid #0080ff;padding-bottom:5px}
    label{font-weight:600;display:block;margin:15px 0 5px;color:#003366}
    input[type="text"],input[type="number"],textarea{width:100%;padding:8px 12px;border-radius:5px;border:1px solid #ccc;font-family:monospace;font-size:14px;box-sizing:border-box;transition:border-color .3s}
    input[type="text"]:focus,input[type="number"]:focus,textarea:focus{border-color:#3399ff;outline:none}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-family:monospace;font-size:15px}
    table th,table td{border:1px solid #ccc;padding:6px 10px;text-align:center;color:#004080}
    table th{background:#e6f0ff}
    table input{border:none;text-align:center;font-weight:bold;font-size:14px;width:100%;padding:4px 0;background:transparent;color:#00264d}
    table input:focus{outline:1px solid #3399ff;background:#dbe9ff}
    .btn{background:#007bff;color:#fff;border:none;border-radius:6px;padding:10px 18px;font-size:15px;cursor:pointer;margin-top:15px;margin-right:10px;transition:background-color .3s;user-select:none}
    .btn:hover{background:#0056b3}
    .btn-red{background:#dc3545;float:right;margin:0 0 15px 0}.btn-red:hover{background:#a61b2b}
    .log{margin-top:15px;background:#f9f9f9;border:1px solid #ddd;border-radius:6px;padding:12px 15px;font-family:monospace;font-size:14px;min-height:120px;white-space:pre-wrap;color:#222}
    .history,#doneList,.historyVI,#doneListVI,.historyTHB,#doneListTHB,.historyABA,#doneListABA{max-height:480px;overflow-y:auto;border:1px solid #ccc;background:#fafafa;border-radius:6px;padding:10px 12px;font-family:monospace;font-size:14px;color:#111}
    .history-entry{border-bottom:1px solid #ccc;padding:10px 8px;margin-bottom:10px;background:#fff;border-radius:5px}
    .history-entry:last-child{margin-bottom:0}
    .entry-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px}
    .entry-header input[type="text"]{flex:1;min-width:160px;padding:6px 10px;font-size:14px;border-radius:4px;border:1px solid #aaa;font-family:inherit;color:#003366}
    .entry-header span{color:#004080;font-weight:600;font-size:14px;user-select:none;white-space:nowrap}
    .entry-header button{margin-left:0;border-radius:5px;font-size:13px;padding:6px 10px;border:none;cursor:pointer;user-select:none;transition:background-color .3s}
    .delete-btn{background:#dc3545;color:#fff}.delete-btn:hover{background:#a61b2b}
    .done-btn{background:#28a745;color:#fff}.done-btn:hover{background:#1e7e34}
    .edit-btn{background:#ffc107;color:#222}.edit-btn:hover{background:#e0a800}
    .entry-content div{display:flex;align-items:center;margin-bottom:4px}
    .entry-content div span{user-select:text}
    .entry-content div input[type="checkbox"]{margin-right:8px;cursor:pointer;transform:scale(1.1)}
    .highlighted{background:#d3f4d3;font-weight:bold}
    .done-entry{border-left:4px solid #28a745;background:#e6f7e6!important;font-weight:bold!important;color:#155724!important}
    .history::-webkit-scrollbar,#doneList::-webkit-scrollbar,.historyVI::-webkit-scrollbar,#doneListVI::-webkit-scrollbar,.historyTHB::-webkit-scrollbar,#doneListTHB::-webkit-scrollbar,.historyABA::-webkit-scrollbar,#doneListABA::-webkit-scrollbar{width:8px}
    .history::-webkit-scrollbar-thumb,#doneList::-webkit-scrollbar-thumb,.historyVI::-webkit-scrollbar-thumb,#doneListVI::-webkit-scrollbar-thumb,.historyTHB::-webkit-scrollbar-thumb,#doneListTHB::-webkit-scrollbar-thumb,.historyABA::-webkit-scrollbar-thumb,#doneListABA::-webkit-scrollbar-thumb{background:#b0c4de;border-radius:4px}
    .btn-container{margin-top:15px;overflow:hidden}
    .tabs{display:inline-flex;border:1px solid #cbd5e1;border-radius:999px;overflow:hidden;background:#fff}
    .tab{padding:8px 14px;border:none;background:transparent;cursor:pointer;font-weight:600;color:#334155}
    .tab.active{background:#0b73ff;color:#fff}
    .topbar{position:fixed;left:16px;top:12px;display:flex;gap:8px;align-items:center;z-index:9999}
    .sync-badge{position:fixed;right:16px;top:12px;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,.15);font-size:16px;color:#111;z-index:9999}
    .sync-ok{background:#e6ffed}.sync-warn{background:#fff7e6}.sync-err{background:#ffe6e6}
    .auth-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#f0f8ff}
    .auth-card{width:360px;max-width:92vw;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.1);padding:20px}
    .auth-card h2{margin:0 0 12px;border:none;color:#0b4aa7}
    .auth-card .row{margin-bottom:10px}
    .auth-card input{width:100%;padding:10px 12px;border:1px solid #cdd6e0;border-radius:8px;font-size:14px}
    .auth-card button{width:100%;padding:10px 12px;border:none;border-radius:8px;background:#0b73ff;color:#fff;font-weight:600;cursor:pointer}
    .auth-msg{margin-top:8px;font-size:13px;color:#a11;min-height:18px}
    @media (max-width:992px){#app,#appVI,#appTHB,#appABA{flex-direction:column}.container{width:100%}}

    /* giữ nguyên style nút logout như bản gốc */
    #logoutBtn{
      position: fixed !important;
      right: 16px !important;
      bottom: 16px !important;
      z-index: 2000 !important;
      background: #ef4444 !important;
      color: #fff !important;
      border-color: #dc2626 !important;
      box-shadow: 0 6px 18px rgba(239,68,68,.35) !important;
      border-radius: 10px !important;
      padding: 10px 16px !important;
    }
    body #logoutBtn:hover{ filter: brightness(1.06); }

    /* Tiny toast (auto-hide ~2s) */
    #toast{
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.82);
      color:#fff;
      padding:6px 10px;
      border-radius:8px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
      z-index:3000;
    }
    #toast.show{opacity:1}
  </style>


<!-- === WOW THEME OVERRIDES (UI only, no logic changes) === -->
<style id="wow-theme">
  :root{
    --bg1:#0f172a; --bg2:#0b1220;
    --ink:#e5e7eb; --ink-dim:#9ca3af;
    --card:rgba(255,255,255,0.06);
    --brand:#60a5fa; --brand-2:#3b82f6; --brand-3:#2563eb;
    --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --ring: rgba(96,165,250,.35);
    --shadow: 0 12px 30px rgba(0,0,0,.25);
    --radius:14px;
  }
  html,body{height:100%;}
  body{
    background: linear-gradient(135deg,var(--bg1),var(--bg2)) fixed !important;
    color: var(--ink);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-height: 100dvh;
    overflow-x: hidden;
  }
  /* Topbar */
  .topbar{
    position: sticky !important;
    top: 8px !important;
    left: auto !important;
    right: auto !important;
    gap:10px !important;
    padding:8px 10px;
    border-radius: 999px;
    background: rgba(15,23,42,.65);
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow);
  }
  .tabs{
    border: 1px solid rgba(148,163,184,.25) !important;
    background: rgba(2,6,23,.45) !important;
  }
  .tab{
    padding:10px 16px !important;
    font-weight:700 !important;
    letter-spacing:.2px;
    color:#cbd5e1 !important;
  }
  .tab.active{
    background: linear-gradient(180deg,var(--brand),var(--brand-3)) !important;
    color:#0b1220 !important;
  }

  /* Cards / containers */
  .container{
    background: var(--card) !important;
    border: 1px solid rgba(148,163,184,.18) !important;
    color: var(--ink) !important;
    border-radius: var(--radius) !important;
    box-shadow: var(--shadow) !important;
  }
  h2,h3{
    color: #bfdbfe !important;
    border: none !important;
    margin-top: 4px !important;
  }
  label{
    color:#cbd5e1 !important;
    font-weight:700 !important;
    letter-spacing:.2px;
  }

  /* Inputs: mobile-friendly */
  input[type="text"], input[type="number"], textarea{
    background: rgba(255,255,255,.06) !important;
    border: 1px solid rgba(148,163,184,.28) !important;
    color: var(--ink) !important;
    border-radius: 12px !important;
    font-size: 16px !important; /* avoid iOS zoom */
    padding: 12px 14px !important;
    -webkit-text-size-adjust: 100%;
    touch-action: manipulation;
  }
  input:focus, textarea:focus{
    outline: none !important;
    box-shadow: 0 0 0 4px var(--ring) !important;
    border-color: var(--brand-2) !important;
    background: rgba(255,255,255,.10) !important;
  }
  ::placeholder{ color: #94a3b8 !important; }

  /* Buttons */
  .btn{
    background: linear-gradient(180deg,var(--brand),var(--brand-3)) !important;
    border: none !important;
    color: #0b1220 !important;
    padding: 12px 18px !important;
    border-radius: 12px !important;
    font-weight: 800 !important;
    letter-spacing:.2px;
    box-shadow: 0 10px 18px rgba(37,99,235,.25) !important;
    transition: transform .06s ease, filter .2s ease;
    min-height: 44px;
  }
  .btn:hover{ filter: brightness(1.04); }
  .btn:active{ transform: translateY(1px) scale(.99); }
  .btn-red{ background: linear-gradient(180deg,#f87171,#ef4444) !important; color: #111 !important; }
  .done-btn{ background: linear-gradient(180deg,#86efac,#22c55e) !important; color:#052e16 !important; }
  .delete-btn{ background: linear-gradient(180deg,#fecaca,#ef4444) !important; color:#111 !important; }
  .edit-btn{ background: linear-gradient(180deg,#fde68a,#f59e0b) !important; color:#111 !important; }

  /* Tables */
  table{
    border-radius: 12px !important;
    overflow: hidden !important;
    border: 1px solid rgba(148,163,184,.22) !important;
  }
  table th{
    background: rgba(30,41,59,.65) !important;
    color: #cbd5e1 !important;
  }
  table td{ color:#e5e7eb !important; border-color: rgba(148,163,184,.18) !important; }
  table input{ color:#e5e7eb !important; }

  /* Toast */
  #toast{
    background: rgba(2,6,23,.9) !important;
    color:#fff !important;
    border: 1px solid rgba(148,163,184,.25) !important;
    padding: 8px 12px !important;
    border-radius: 999px !important;
    font-weight:800 !important;
  }

  /* Auth card */
  .auth-wrap{ background: linear-gradient(135deg,var(--bg1),var(--bg2)) !important; }
  .auth-card{
    background: rgba(255,255,255,.06) !important;
    border: 1px solid rgba(148,163,184,.25) !important;
    color: var(--ink) !important;
    border-radius: 16px !important;
    box-shadow: var(--shadow) !important;
    backdrop-filter: blur(10px) saturate(140%);
  }
  .auth-card h2{ color:#bfdbfe !important; }
  .auth-card input{ font-size:16px !important; }

  /* History entries */
  .history,.historyVI,.historyTHB,.historyABA,
  #doneList,#doneListVI,#doneListTHB,#doneListABA{
    background: rgba(2,6,23,.35) !important;
    border: 1px solid rgba(148,163,184,.22) !important;
    color: var(--ink) !important;
  }
  .history-entry{
    background: rgba(255,255,255,.06) !important;
    border: 1px solid rgba(148,163,184,.22) !important;
    border-radius: 12px !important;
  }
  .done-entry{
    border-left: 4px solid var(--ok) !important;
    background: rgba(22,163,74,.12) !important;
    color:#bbf7d0 !important;
  }

  /* Logout button retains float but with glow */
  #logoutBtn{
    box-shadow: 0 14px 24px rgba(239,68,68,.45) !important;
    border: none !important;
    font-weight: 800 !important;
    min-height: 44px;
  }

  /* Better spacing on mobile */
  @media (max-width: 992px){
    body{ padding: 8px !important; }
    .container{ padding: 16px 14px !important; }
    .btn{ width: auto; }
    .btn-container{ display: flex; flex-wrap: wrap; gap: 8px; }
  }

  /* Touch polish */
  * { -webkit-tap-highlight-color: transparent; }
  input, textarea, button { touch-action: manipulation; }
</style>


<!-- === WOW+ BRAND + TIMELINE & CONTRAST FIX (UI-only) === -->
<style id="wow-contrast">
  :root{
    /* Accessible token colors */
    --token-bg:#fef3c7;      /* amber-100 (for light tokens) */
    --token-fg:#78350f;      /* on-amber */
    --token-bg2:#d1fae5;     /* emerald-100 */
    --token-fg2:#065f46;
    --chip-bg: rgba(148,163,184,.16);
    --chip-fg: #e5e7eb;
  }

  /* --- Brand pill in topbar (injected via JS) --- */
  .brand-pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:999px;
    background: linear-gradient(180deg,#60a5fa,#2563eb);
    color:#0b1220; font-weight:900; letter-spacing:.3px;
    box-shadow: 0 10px 18px rgba(37,99,235,.35);
    margin-right:10px;
  }
  .brand-pill svg{ width:18px; height:18px; }

  /* --- Tab icons --- */
  .tab{ position: relative; padding-left: 36px !important; }
  .tab::before{
    content: attr(data-ico);
    position:absolute; left:12px; top:50%; transform: translateY(-50%);
    width:20px; height:20px; display:grid; place-items:center;
    background:#0b1220; color:#93c5fd; border:1px solid rgba(148,163,184,.25);
    border-radius:6px; font-size:12px; font-weight:900;
    box-shadow: inset 0 0 12px rgba(59,130,246,.25);
  }

  /* --- High-contrast highlight chips (for inline values) --- */
  mark, .highlight, .hl, .chip{
    background: var(--token-bg);
    color: var(--token-fg);
    padding: 2px 6px; border-radius: 8px; font-weight: 800;
  }
  .chip-2{ background: var(--token-bg2); color: var(--token-fg2); }
  /* If previous theme added low-contrast highlights, neutralize then reapply readable style */
  .history .highlight, .history mark{ filter: none !important; mix-blend-mode: normal !important; }

  /* --- Buttons subtle palette harmonization --- */
  .btn{ text-shadow: none !important; }
  .btn.warn{ background: linear-gradient(180deg,#fde68a,#f59e0b) !important; color:#111827 !important; }
  #logoutBtn{ filter: drop-shadow(0 12px 24px rgba(239,68,68,.35)); }

  /* --- Timeline styling for history sections (no markup changes) --- */
  .history, .historyVI, .historyTHB, .historyABA{
    position: relative; padding-left: 24px !important;
  }
  .history::before, .historyVI::before, .historyTHB::before, .historyABA::before{
    content:""; position:absolute; left: 10px; top: 12px; bottom: 12px;
    width:2px; background: rgba(148,163,184,.35);
    border-radius:2px;
  }
  /* Try to match common child blocks as items */
  .history > div, .history > li, .history .history-entry,
  .historyVI > div, .historyTHB > div, .historyABA > div{
    position: relative; margin-left: 0;
  }
  .history > div::before, .history > li::before, .history .history-entry::before,
  .historyVI > div::before, .historyTHB > div::before, .historyABA > div::before{
    content:""; position:absolute; left: -17px; top: 16px;
    width:10px; height:10px; border-radius:50%;
    background:#3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.25);
  }
  /* Completed items glow green */
  .done-entry::before{ background:#22c55e !important; box-shadow:0 0 0 3px rgba(34,197,94,.25) !important; }

  /* --- Chips for timestamps --- */
  .time-chip{
    display:inline-block; padding:2px 8px; border-radius:999px;
    background: var(--chip-bg); color: var(--chip-fg);
    font-weight:700; font-size:12px; letter-spacing:.2px;
  }

  /* --- Improve checkbox label contrast inside history --- */
  .history label, .historyVI label, .historyTHB label, .historyABA label{
    color:#e5e7eb !important;
  }
  .history input[type="checkbox"] + label, 
  .historyVI input[type="checkbox"] + label,
  .historyTHB input[type="checkbox"] + label,
  .historyABA input[type="checkbox"] + label{
    background: transparent !important;
  }
</style>


<!-- === ULTRA WOW SKIN (UI-only; no logic changes) === -->
<style id="wow-ultra">
  :root{
    --accent1:#7dd3fc; /* sky-300 */
    --accent2:#60a5fa; /* blue-400 */
    --accent3:#a78bfa; /* violet-400 */
    --success:#22c55e;
    --danger:#ef4444;
    --panel:#0b1220;
    --glass: rgba(255,255,255,.06);
  }

  /* Aurora background */
  body::before{
    content:""; position: fixed; inset:-20%; z-index:-1;
    background:
      radial-gradient(45% 35% at 20% 20%, rgba(96,165,250,.25), transparent 60%),
      radial-gradient(40% 30% at 80% 10%, rgba(167,139,250,.22), transparent 60%),
      radial-gradient(50% 40% at 50% 90%, rgba(125,211,252,.15), transparent 60%);
    filter: blur(40px);
    opacity:.9; pointer-events:none;
    animation: float-aurora 18s ease-in-out infinite alternate;
  }
  @keyframes float-aurora{
    from { transform: translateY(0) rotate(0deg) scale(1); }
    to   { transform: translateY(-2%) rotate(2deg) scale(1.02); }
  }
  @media (prefers-reduced-motion: reduce){
    body::before{ animation:none; }
  }

  /* Neon gradient frame for containers */
  .container, .card, .history, .historyVI, .historyTHB, .historyABA, #doneList, #doneListVI, #doneListTHB, #doneListABA{
    position: relative;
    border-radius: 16px !important;
    overflow: hidden;
  }
  .container::before, .card::before, .history::before, .historyVI::before, .historyTHB::before, .historyABA::before,
  #doneList::before, #doneListVI::before, #doneListTHB::before, #doneListABA::before{
    content:""; position:absolute; inset:0; pointer-events:none;
    padding:1px; border-radius: inherit;
    background: conic-gradient(from 180deg, var(--accent1), var(--accent2), var(--accent3), var(--accent2), var(--accent1));
    -webkit-mask:
      linear-gradient(#000 0 0) content-box, 
      linear-gradient(#000 0 0);
    -webkit-mask-composite: xor;
            mask-composite: exclude;
    opacity:.35;
  }
  .container::after, .card::after{
    content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
  }

  /* Button icons + ripple */
  .btn{ position: relative; overflow: hidden; }
  .btn[data-icon]::before{
    content: attr(data-icon);
    display:inline-block; margin-right:8px; font-weight:900;
    background: rgba(2,6,23,.2); border:1px solid rgba(148,163,184,.25);
    width:22px; height:22px; border-radius:6px; line-height:22px; text-align:center;
  }
  .ripple{
    position:absolute; border-radius:50%; transform:scale(0);
    opacity:.35; pointer-events:none;
    background: radial-gradient(circle at center, rgba(255,255,255,.6), rgba(255,255,255,0) 60%);
    animation: ripple .6s ease-out forwards;
  }
  @keyframes ripple{ to { transform: scale(8); opacity:0; } }

  /* Button palette tweaks for readability */
  .btn.ok, .done-btn{ color:#052e16 !important; }
  .btn.danger, .delete-btn{ color:#111 !important; }

  /* Checkbox prettify */
  input[type="checkbox"]{
    width: 18px; height:18px; appearance: none;
    border-radius:6px; border:1px solid rgba(148,163,184,.4);
    background: rgba(255,255,255,.05);
    display:inline-grid; place-items:center;
  }
  input[type="checkbox"]::after{
    content:""; width:12px; height:12px; border-radius:3px; transform: scale(0);
    background: linear-gradient(180deg,var(--accent2),var(--accent3));
    transition: transform .12s ease;
  }
  input[type="checkbox"]:checked::after{ transform: scale(1); }

  /* Timeline polish (reuse existing) */
  .history.timeline, .historyVI.timeline, .historyTHB.timeline, .historyABA.timeline{
    padding-left: 24px !important;
  }
  .history.timeline > div::before, .history.timeline > li::before,
  .historyVI.timeline > div::before, .historyTHB.timeline > div::before, .historyABA.timeline > div::before{
    background: linear-gradient(180deg,var(--accent2),var(--accent3)) !important;
    box-shadow: 0 0 0 3px rgba(96,165,250,.25) !important;
  }

  /* Done cards legibility */
  .done-entry, #doneList, #doneListVI, #doneListTHB, #doneListABA{
    background: rgba(16,185,129,.09) !important;
    border: 1px solid rgba(16,185,129,.35) !important;
    color: #d1fae5 !important;
  }
  .done-entry *, #doneList *, #doneListVI *, #doneListTHB *, #doneListABA *{
    color: #d1fae5 !important;
  }

  /* High-contrast inline tokens */
  mark, .highlight, .hl{ 
    background: #fef3c7 !important; color:#78350f !important;
    padding: 2px 6px; border-radius: 8px; font-weight: 800;
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar{ width: 10px; height: 10px; }
  ::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.35); border-radius: 999px; }
  ::-webkit-scrollbar-track{ background: transparent; }

  /* Inputs contrast inside dark panels */
  .history input[type="text"], .history textarea,
  .historyVI input[type="text"], .historyTHB input[type="text"], .historyABA input[type="text"]{
    background: rgba(255,255,255,.06) !important;
    color: #e5e7eb !important;
    border: 1px solid rgba(148,163,184,.25) !important;
  }
</style>


<style id="wow-patch-icons-off">
  /* Remove pseudo icon before tabs */
  .tab::before { content: none !important; display: none !important; }
</style>


<style id="wow-checked-contrast">
  /* High-contrast chip for checked lines (mobile-friendly) */
  .history input[type="checkbox"]:checked + label,
  .historyVI input[type="checkbox"]:checked + label,
  .historyTHB input[type="checkbox"]:checked + label,
  .historyABA input[type="checkbox"]:checked + label,
  /* Fallback: if the text node is not a <label> but any inline element */
  .history input[type="checkbox"]:checked + *:not(input):not(button),
  .historyVI input[type="checkbox"]:checked + *:not(input):not(button),
  .historyTHB input[type="checkbox"]:checked + *:not(input):not(button),
  .historyABA input[type="checkbox"]:checked + *:not(input):not(button) {
    background: #f0fdf4 !important;   /* emerald-50 */
    color: #052e16 !important;         /* deep green for contrast */
    border: 1px solid rgba(16,185,129,.55) !important;
    border-radius: 8px !important;
    padding: 2px 8px !important;
    font-weight: 800 !important;
    box-shadow: 0 0 0 3px rgba(16,185,129,.15) inset;
  }

  /* Ensure previous low-contrast highlight tokens don't override */
  .history mark, .history .highlight, .history .hl,
  .historyVI mark, .historyVI .highlight, .historyVI .hl,
  .historyTHB mark, .historyTHB .highlight, .historyTHB .hl,
  .historyABA mark, .historyABA .highlight, .historyABA .hl{
    background: transparent !important;
    color: inherit !important;
  }
</style>


<!-- Vietnamese-safe font: Be Vietnam Pro -->

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<style id="wow-vn-font">
  :root{ --ui-font: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Liberation Sans", "Noto Sans", sans-serif; }
  html, body{ font-family: var(--ui-font) !important; font-synthesis: none; text-rendering: optimizeLegibility; }
  .btn{ letter-spacing: 0.05px !important; line-height: 1.15 !important; }
  .tab{ letter-spacing: 0.05px !important; }
  /* Keep monospaced areas intact */
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", "Courier New", monospace !important; }
</style>


<!-- Add Noto Sans (Vietnamese-safe) and prefer it over others -->

<style id="wow-vn-font-2">
  :root{ --ui-font: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Liberation Sans", "Noto Sans", sans-serif; }
  html, body{ font-family: var(--ui-font) !important; font-synthesis: none; text-rendering: optimizeLegibility; }
  .btn{ letter-spacing: 0 !important; line-height: 1.2 !important; font-weight: 700 !important; }
  .tab{ letter-spacing: 0 !important; font-weight: 700 !important; }
</style>


<style id="wow-rounding-safe-css">
  /* Safer: style the whole line via a class without replacing inner HTML */
  .rounding-hint-line{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    background: linear-gradient(180deg,#fde68a,#f59e0b);
    color: #0b1220 !important;
    font-weight: 800;
    letter-spacing: .1px;
    border: 1px solid rgba(161,98,7,.45);
    box-shadow: 0 8px 18px rgba(245,158,11,.25), inset 0 1px 0 rgba(255,255,255,.35);
    line-height: 1.2;
    width: fit-content;
  }
  .rounding-hint-line .emoji{ display:inline-grid; place-items:center; width:20px; height:20px; border-radius:6px; background: rgba(2,6,23,.12); border:1px solid rgba(0,0,0,.12); font-size:14px; }
</style>

</head>
<body>
  <div id="toast" aria-live="polite"></div>
  <!-- Topbar (ẩn trước khi login) -->
  <div id="topbar" class="topbar" hidden>
    <button id="logoutBtn" class="btn" hidden>Đăng xuất</button>
    <div class="tabs" style="margin-left:8px;">
      <button class="tab active" id="tabIDR">I</button>
      <button class="tab" id="tabVI">V</button>
      <button class="tab" id="tabTHB">Tê</button>
      <button class="tab" id="tabABA">AB</button>
    </div>
  </div>

  <!-- Badge Sync -->
  <div id="syncStatus" class="sync-badge sync-warn" title="Local only">🔄</div>

  <!-- Login -->
  <div id="loginWrap" class="auth-wrap">
    <div class="auth-card">
      <h2>Đăng nhập</h2>
      <div class="row"><input id="email" type="email" placeholder="Email" autocomplete="off" autocapitalize="off" spellcheck="false" /></div>
      <div class="row"><input id="password" type="password" placeholder="Mật khẩu" autocomplete="off" autocapitalize="off" spellcheck="false" /></div>
      <button id="loginBtn">Đăng nhập</button>
      <div id="loginMsg" class="auth-msg"></div>
      <div style="font-size:12px;color:#666;margin-top:6px">Tài khoản do admin cấp. Không mở đăng ký.</div>
    </div>
  </div>

  <!-- PAGE: IDR -->
  <div id="pageIDR" style="margin-top:60px;" hidden>
    <div id="app" hidden style="display:none">
      <div class="container">
        <h2>Caculator — Trang "I"</h2>
        <label>Tỷ giá:</label>
        <table>
          <thead><tr><th>Loại</th><th>Tỷ giá</th></tr></thead>
          <tbody>
            <tr><td>IDR / U</td><td><input type="number" id="rateU" placeholder="U" oninput="calculate()" autocomplete="off" autocapitalize="off" spellcheck="false" /></td></tr>
            <tr><td>IDR / ABA</td><td><input type="number" id="rateABA" placeholder="ABA" oninput="calculate()" autocomplete="off" autocapitalize="off" spellcheck="false" /></td></tr>
          </tbody>
        </table>
        <label>USDT:</label><input type="text" id="usdt_input" placeholder="VD: 1k, 1.2k, 1350.5" oninput="calculate()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <label>ABA:</label><input type="text" id="aba_input" placeholder="VD: 2k, 5000" oninput="calculate()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <label>IDR ➝ USDT:</label><input type="number" id="idr_usdt_input" placeholder="Nhập IDR đổi USDT" oninput="calculate()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <label>IDR ➝ ABA:</label><input type="number" id="idr_aba_input" placeholder="Nhập IDR đổi ABA" oninput="calculate()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <div class="btn-container">
          <button class="btn" onclick="copyForm()">Copy Form</button>
          <button class="btn" onclick="addToHistory()">Add vào lịch sử</button>
        </div>
        <div class="log" id="log"></div>
      </div>
      <div class="container">
        <h3>Lịch sử <button class="btn btn-red" style="float:right" onclick="clearHistory()">Xóa toàn bộ lịch sử</button></h3>
        <div class="history" id="history"></div>
        <h3>Đã xong</h3>
        <div id="doneList"></div>
      </div>
    </div>
  </div>

  <!-- PAGE: VI -->
  <div id="pageVI" style="margin-top:60px;" hidden>
    <div id="appVI" hidden style="display:none">
      <div class="container">
        <h2>Caculator — Trang "VI"</h2>
        <label>Tỷ giá VI:</label>
        <table>
          <thead><tr><th>Loại</th><th>Tỷ giá</th></tr></thead>
          <tbody>
            <tr><td>VND / USDT</td><td><input type="number" id="rateVI" placeholder="V" oninput="calculateVI()" autocomplete="off" autocapitalize="off" spellcheck="false" /></td></tr>
          </tbody>
        </table>
        <label>Vi (VND ➝ USDT):</label><input type="text" id="vi_input" placeholder="VD: 1B, 5m, 2,5m" oninput="calculateVI()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <label>U (USDT ➝ VND):</label><input type="text" id="u_input_vi" placeholder="VD: 100, 1.2k, 3m" oninput="calculateVI()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <div class="btn-container">
          <button class="btn" onclick="copyFormVI()">Copy Form</button>
          <button class="btn" onclick="addToHistoryVI()">Add vào lịch sử</button>
        </div>
        <div class="log" id="logVI"></div>
      </div>
      <div class="container">
        <h3>Lịch sử <button class="btn btn-red" style="float:right" onclick="clearHistoryVI()">Xóa toàn bộ lịch sử</button></h3>
        <div class="historyVI" id="historyVI"></div>
        <h3>Đã xong</h3>
        <div id="doneListVI"></div>
      </div>
    </div>
  </div>

  <!-- PAGE: THB -->
  <div id="pageTHB" style="margin-top:60px;" hidden>
    <div id="appTHB" hidden style="display:none">
      <div class="container">
        <h2>Caculator — Trang "Tê"</h2>
        <label>Tỷ giá THB:</label>
        <table>
          <thead><tr><th>Loại</th><th>Tỷ giá</th></tr></thead>
          <tbody>
            <tr><td>THB / USDT</td><td><input type="number" id="rateTHB" placeholder="VD: 33.25" step="0.01" oninput="calculateTHB()" autocomplete="off" autocapitalize="off" spellcheck="false" /></td></tr>
          </tbody>
        </table>
        <label>Tê (THB ➝ USDT):</label>
        <input type="text" id="thb_input" placeholder="VD: 300k, 1.5m " oninput="calculateTHB()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <label>U (USDT ➝ THB):</label>
        <input type="text" id="u_input_thb" placeholder="VD: 100, 2.5 (giữ số thập phân)" oninput="calculateTHB()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <div class="btn-container">
          <button class="btn" onclick="copyFormTHB()">Copy Form</button>
          <button class="btn" onclick="addToHistoryTHB()">Add vào lịch sử</button>
        </div>
        <div class="log" id="logTHB"></div>
      </div>
      <div class="container">
        <h3>Lịch sử <button class="btn btn-red" style="float:right" onclick="clearHistoryTHB()">Xóa toàn bộ lịch sử</button></h3>
        <div class="historyTHB" id="historyTHB"></div>
        <h3>Đã xong</h3>
        <div id="doneListTHB"></div>
      </div>
    </div>
  </div>

  <!-- PAGE: ABA (layout giữ nguyên: #appABA là wrapper flex chứa 2 container) -->
  <div id="pageABA" style="margin-top:60px;" hidden>
    <div id="appABA" hidden style="display:none">
      <div class="container">
        <h2>Caculator — Trang "ABA"</h2>
        <label>Tỷ giá ABA:</label>
        <table>
          <thead><tr><th>Loại</th><th>Tỷ giá</th></tr></thead>
          <tbody>
            <tr>
              <td>USDT ⇄ ABA</td>
              <td><input type="text" id="rateABA4" placeholder="VD: 0.993" oninput="calculateABA()" autocomplete="off" autocapitalize="off" spellcheck="false" /></td>
            </tr>
          </tbody>
        </table>

        <label>Số lượng:</label>
        <input type="text" id="amountABA" placeholder="VD: 10k, 100.125" oninput="calculateABA()" autocomplete="off" autocapitalize="off" spellcheck="false">

        <div class="round-toggle" style="margin:8px 0 4px; display:inline-flex; gap:8px; align-items:center;">
          <button id="roundIconABA" type="button" title="Chế độ hiện tại: làm tròn xuống&#10;Bấm để đổi (floor → round → ceil)" style="border:none;background:transparent;font-size:18px;cursor:pointer;line-height:1" data-mode="floor">📱</button>
          <span id="roundModeLabelABA" style="font-weight:600;color:#003366">Làm tròn: <b>làm tròn xuống</b></span>
        </div>

        <!-- Bảng 1: USDT -> ABA -->
        <div class="btn-container">
          <button class="btn" onclick="copyLog('logABA_u2a')">Copy form USDT→ABA</button>
          <button class="btn" onclick="addToHistoryABA_U2A()">Add vào lịch sử (USDT→ABA)</button>
        </div>
        <div class="log" id="logABA_u2a"></div>

        <!-- Bảng 2: ABA -> USDT -->
        <div class="btn-container">
          <button class="btn" onclick="copyLog('logABA_a2u')">Copy form ABA→USDT</button>
          <button class="btn" onclick="addToHistoryABA_A2U()">Add vào lịch sử (ABA→USDT)</button>
        </div>
        <div class="log" id="logABA_a2u"></div>
      </div>

      <div class="container">
        <h3>Lịch sử <button class="btn btn-red" style="float:right" onclick="clearHistoryABA()">Xóa toàn bộ lịch sử</button></h3>
        <div class="historyABA" id="historyABA"></div>
        <h3>Đã xong</h3>
        <div id="doneListABA"></div>
      </div>
    </div>
  </div>

  <!-- ===== JS tiện ích & tính toán ===== -->
  <script>
    // === Tiny toast helper ===
    function showToast(msg){
      const el=document.getElementById('toast'); if(!el) return;
      el.textContent = msg || 'Đã sao chép';
      el.classList.add('show');
      clearTimeout(showToast._tmr);
      showToast._tmr = setTimeout(()=>el.classList.remove('show'), 2000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      try{ setupABRoundToggle(); }catch(e){}
      const sel = [
        '#rateU','#rateABA','#usdt_input','#aba_input','#idr_usdt_input','#idr_aba_input',
        '#rateVI','#vi_input','#u_input_vi',
        '#rateTHB','#thb_input','#u_input_thb',
        '#rateABA4','#amountABA',
        '#email','#password'
      ].join(',');
      document.querySelectorAll(sel).forEach(el=>{
        el.setAttribute('autocomplete','off');
        el.setAttribute('autocapitalize','off');
        el.setAttribute('spellcheck','false');
        if(!el.getAttribute('name')) el.setAttribute('name', el.id || ('field_'+Math.random().toString(36).slice(2)));
      });

      });

    // Clipboard fallback helper: dùng Clipboard API nếu có, nếu không rơi về textarea + execCommand
    function copyTextSafe(t){
      if(!t) return;
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(t).then(()=>showToast('Đã sao chép'), ()=>fallback());
      } else { fallback(); }
      function fallback(){
        const ta=document.createElement('textarea'); ta.value=t;
        document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); showToast('Đã sao chép'); }
        finally { ta.remove(); }
      }
    }

    // parseInput dùng chung
    function parseInput(value){
      if(value===undefined||value===null) return NaN;
      let val=String(value).trim(); if(!val) return NaN;
      let mul=1; const suf=val.match(/([kmbKMB])\s*$/);
      if(suf){ const c=suf[1].toLowerCase(); if(c==='k') mul=1e3; else if(c==='m') mul=1e6; else if(c==='b') mul=1e9; val=val.replace(/([kmbKMB])\s*$/,'').trim(); }
      let s=val.replace(/\s/g,'');
      if(s.includes('.') && s.includes(',')){ s=s.replace(/\./g,'').replace(',', '.'); }
      else if(s.includes(',')){ const p=s.split(','); if(p.length===2 && p[1].length<=2) s=p[0]+'.'+p[1]; else s=s.replace(/,/g,''); }
      else if(s.includes('.')){ const p=s.split('.'); if(!(p.length===2 && p[1].length<=2)) s=s.replace(/\./g,''); }
      const num=parseFloat(s); if(isNaN(num)) return NaN;
      return num*mul;
    }

    // === ABA rounding toggle ===
    function labelForRoundModeABA(mode){
      if(mode==='ceil')  return 'làm tròn lên';
      if(mode==='round') return 'làm tròn chuẩn';
      return 'làm tròn xuống';
    }
    function getRoundModeABA(){
      const ico = document.getElementById('roundIconABA');
      return ico ? (ico.dataset.mode || 'floor') : 'floor';
    }
    function setRoundModeABA(mode){
      const ico=document.getElementById('roundIconABA');
      const lbl=document.getElementById('roundModeLabelABA');
      const text = labelForRoundModeABA(mode);
      if(ico){ ico.dataset.mode = mode; ico.title = `Chế độ hiện tại: ${text}\nBấm để đổi (floor → round → ceil)`; }
      if(lbl){ lbl.innerHTML = 'Làm tròn: <b>' + text + '</b>'; }
    }
    function cycleRoundModeABA(){
      const order = ['floor','round','ceil'];
      const cur = getRoundModeABA();
      const next = order[(order.indexOf(cur)+1) % order.length];
      setRoundModeABA(next);
      if (typeof calculateABA === 'function') try { calculateABA(); } catch (e) {}
    }
    function roundByModeABA(n, mode){
      const x = Number(n)||0;
      if(mode==='ceil') return Math.ceil(x);
      if(mode==='round') return Math.round(x);
      return Math.floor(x);
    }
    function formatResultByMode(n){
      const mode = getRoundModeABA();
      if(mode==='round'){ return Number(n).toLocaleString('en-US',{ maximumFractionDigits: 2 }); }
      return roundByModeABA(n, mode).toLocaleString('en-US');
    }
    function setupABRoundToggle(){
      const ico = document.getElementById('roundIconABA');
      if(!ico) return;
      if(!ico.dataset.mode) ico.dataset.mode='floor';
      ico.addEventListener('click', cycleRoundModeABA);
      setRoundModeABA(getRoundModeABA());
    }

    /* ===== HÀM PARSE RIÊNG CHO ABA ===== */
    function parseRateABA(v){
      if(v===undefined||v===null) return NaN;
      let s=String(v).trim(); if(!s) return NaN;
      s=s.replace(/\s/g,'');
      if(s.includes('.') && s.includes(',')){ s=s.replace(/,/g,''); }
      else if(s.includes(',') && !s.includes('.')){ s=s.replace(',', '.'); }
      const n=parseFloat(s);
      return isNaN(n)?NaN:n;
    }
    function parseAmountABA(v){
      if(v===undefined||v===null) return NaN;
      let s=String(v).trim(); if(!s) return NaN;
      let mul=1; const suf=s.match(/([kmbKMB])\s*$/);
      if(suf){ const c=suf[1].toLowerCase(); if(c==='k') mul=1e3; else if(c==='m') mul=1e6; else if(c==='b') mul=1e9; s=s.replace(/([kmbKMB])\s*$/,'').trim(); }
      s=s.replace(/\s/g,'');
      if(s.includes('.') && s.includes(',')){ s=s.replace(/,/g,''); }
      else if(s.includes(',') && !s.includes('.')){ s=s.replace(',', '.'); }
      const n=parseFloat(s);
      return isNaN(n)?NaN:n*mul;
    }

    // Định dạng
    
    // Định dạng — rebuilt clean to avoid any syntax glitches
    function formatCurrencyVN(n){
      if(!Number.isFinite(Number(n))) return '';
      const r = Number(n);
      // Dùng chuẩn Đức cho dấu phẩy thập phân như VND/IDR mẫu gốc
      return r.toLocaleString('de-DE').replace(/\./g, ',');
    }
    function formatSmartDecimal(n){
      const x = Number(n);
      if(!Number.isFinite(x)) return '';
      const q = Math.round((x + Number.EPSILON) * 100) / 100;
      const isInt = Math.abs(q - Math.round(q)) < 1e-9;
      return isInt
        ? Math.round(q).toLocaleString('en-US', { maximumFractionDigits: 0 })
        : q.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    // THB: formatter độc lập (không phụ thuộc mode ABA)
    function formatUSDT_THB(n){
      if(!Number.isFinite(Number(n))) return '';
      return Number(n).toLocaleString('en-US', { maximumFractionDigits: 2 });
    }
    function formatUSDT2(n){
      if(!Number.isFinite(Number(n))) return '';
      return Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    }
    function formatGeneric(n){
      if(!Number.isFinite(Number(n))) return '';
      return Number(n).toLocaleString('en-US',{maximumFractionDigits:8});
    }
    function formatIDR(n){ return Math.round(Number(n)).toLocaleString('de-DE').replace(/\./g,','); }
    function formatVNDInt(n){ return Math.round(Number(n)).toLocaleString('de-DE').replace(/\./g,','); }
    function formatRateTHB(n){ if(isNaN(n)) return ''; return Number(n).toFixed(2); }
    function formatTHBInt(n){ return Math.round(Number(n)).toLocaleString('en-US'); }

    function formatIDR(n){return Math.round(n).toLocaleString('de-DE').replace(/\./g,',');}
    function formatVNDInt(n){return Math.round(n).toLocaleString('de-DE').replace(/\./g,',');}
    function formatRateTHB(n){ if(isNaN(n)) return ''; return Number(n).toFixed(2); }
    function formatTHBInt(n){ return Math.round(Number(n)).toLocaleString('en-US'); }
    function getToday(){const d=new Date();return`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;}
    function getCurrentTime(){const d=new Date();return`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;}

    /* ========= IDR ========= */
    function getRates(){const rateU=parseFloat(document.getElementById('rateU').value);const rateABA=parseFloat(document.getElementById('rateABA').value);return{rateU,rateABA};}
    function calculate(){
      const {rateU,rateABA}=getRates();
      const usdtVal=document.getElementById('usdt_input').value;
      const abaVal=document.getElementById('aba_input').value;
      const idrUsdtRaw=document.getElementById('idr_usdt_input').value.trim();
      const idrAbaRaw=document.getElementById('idr_aba_input').value.trim();
      let log='', today=getToday();
      if(!rateU && !rateABA){document.getElementById("log").innerText="Không tìm thấy tỷ giá.";return;}
      if(usdtVal){const usdt=parseInput(usdtVal);if(!isNaN(usdt)&&rateU){const fee=usdt<5000?7:0;const total=usdt+fee;const idr=total*rateU;log+=`${today}\nUSDT: ${formatCurrencyVN(usdt)}${fee>0?` + ${fee} (fee)`:''} @ ${rateU}\nIDR: ${formatIDR(idr)}\n\n`;}}
      if(abaVal){const aba=parseInput(abaVal);if(!isNaN(aba)&&rateABA){const fee=aba<5000?10:0;const total=aba+fee;const idr=total*rateABA;log+=`${today}\nABA: ${formatCurrencyVN(aba)}${fee>0?` + ${fee} (fee)`:''} @ ${rateABA}\nIDR: ${formatIDR(idr)}\n\n`;}}
      if(idrUsdtRaw && !isNaN(parseFloat(idrUsdtRaw)) && rateU){const idr=parseFloat(idrUsdtRaw);const usdt=idr/rateU;log+=`${today}:\nIDR: ${formatIDR(idr)} @ ${rateU}\nUSDT: ${formatSmartDecimal(usdt)}\n\n`;}
      if(idrAbaRaw && !isNaN(parseFloat(idrAbaRaw)) && rateABA){const idr=parseFloat(idrAbaRaw);const aba=idr/rateABA;log+=`${today}:\nIDR: ${formatIDR(idr)} @ ${rateABA}\nABA: ${Math.round(aba).toLocaleString('en-US')}\n\n`;}
      document.getElementById("log").innerText=log||"Không có dữ liệu.";
    }
    function copyForm(){
      const t=document.getElementById("log").innerText;
      if(t.trim()) copyTextSafe(t);
    }

    function addToHistory(){
      // realtime xử lý ở phần Firebase bên dưới
    }

    /* ========= VI ========= */
    function calculateVI(){
      const rate=parseFloat(document.getElementById('rateVI').value);
      const viVal=document.getElementById('vi_input').value;
      const uVal=document.getElementById('u_input_vi').value;
      let log='', today=getToday();
      if(!rate){document.getElementById("logVI").innerText="Không tìm thấy tỷ giá.";return;}
      if(viVal){const vnd=parseInput(viVal);if(!isNaN(vnd)){const usdt=vnd/rate;log+=`${today}\nVND: ${formatVNDInt(vnd)} @ ${formatVNDInt(rate)}\nUSDT: ${formatSmartDecimal(usdt)}\n\n`;}}
      if(uVal){const usdt=parseInput(uVal);if(!isNaN(usdt)){const vnd=usdt*rate;log+=`${today}\nUSDT: ${formatCurrencyVN(usdt)} @ ${formatVNDInt(rate)}\nVND: ${formatVNDInt(vnd)}\n\n`;}}
      document.getElementById("logVI").innerText=log||"Không có dữ liệu.";
    }
    function copyFormVI(){ const t=document.getElementById("logVI").innerText; if(t.trim()) copyTextSafe(t); }

    /* ========= THB ========= */
    function calculateTHB(){
      const rate = parseFloat(document.getElementById('rateTHB').value);
      const thbVal = document.getElementById('thb_input').value;
      const uVal   = document.getElementById('u_input_thb').value;
      let log='', today=getToday();
      if(!rate){ document.getElementById("logTHB").innerText="Không tìm thấy tỷ giá."; return; }
      if(thbVal){
        const thb = parseInput(thbVal);
        if(!isNaN(thb)){
          const usdt = thb / rate;
          log += `${today}\nTHB: ${formatTHBInt(thb)} @ ${rate.toFixed(2)}\nUSDT: ${formatUSDT_THB(usdt)}\n\n`;
        }
      }
      if(uVal){
        const usdt = parseInput(uVal);
        if(!isNaN(usdt)){
          const thb = usdt * rate;
          log += `${today}\nUSDT: ${formatUSDT_THB(usdt)} @ ${rate.toFixed(2)}\nTHB: ${formatTHBInt(thb)}\n\n`;
        }
      }
      document.getElementById("logTHB").innerText = log || "Không có dữ liệu.";
    }
    function copyFormTHB(){ const t=document.getElementById("logTHB").innerText; if(t.trim()) copyTextSafe(t); }

    /* ========= ABA ========= */
    function calculateABA(){
      const rateStr = document.getElementById('rateABA4').value?.trim();
      const amtStr  = document.getElementById('amountABA').value?.trim();
      const rate = parseRateABA(rateStr);
      const amt  = parseAmountABA(amtStr);
      const today = getToday();
      let log1 = '', log2 = '';
      if(!rate){ document.getElementById("logABA_u2a").innerText="Không tìm thấy tỷ giá."; document.getElementById("logABA_a2u").innerText="Không tìm thấy tỷ giá."; return; }
      if(!amtStr){ document.getElementById("logABA_u2a").innerText=""; document.getElementById("logABA_a2u").innerText=""; return; }
      if(!isNaN(amt)){
        const aba = amt * rate; // USDT -> ABA
        log1 += `${today}\nUSDT: ${amtStr} @ ${rateStr}\nABA: ${formatResultByMode(aba)}\n\n`;
        const usdt = rate !== 0 ? (amt / rate) : 0; // ABA -> USDT
        log2 += `${today}\nABA: ${amtStr} @ ${rateStr}\nUSDT: ${formatResultByMode(usdt)}\n\n`;
      }
      document.getElementById("logABA_u2a").innerText = log1 || "";
      document.getElementById("logABA_a2u").innerText = log2 || "";
    }
    function copyLog(id){ const t=document.getElementById(id).innerText; if(t.trim()) copyTextSafe(t); }
  </script>

  <!-- ===== Firebase + Auth + Realtime ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDcyh6-XOKIS8GLCx24aAT5WPewc-Cu0RM",
      authDomain: "testsever1-1f5c9.firebaseapp.com",
      databaseURL: "https://testsever1-1f5c9-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "testsever1-1f5c9",
      storageBucket: "testsever1-1f5c9.firebasestorage.app",
      messagingSenderId: "587078219356",
      appId: "1:587078219356:web:5684169dcabbf85a0e9899"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);
    setPersistence(auth, browserLocalPersistence);

    const statusEl  = document.getElementById('syncStatus');
    const appEl     = document.getElementById('app');
    const appVIEl   = document.getElementById('appVI');
    const appTHBEl  = document.getElementById('appTHB');
    const appABAEl  = document.getElementById('appABA');
    const pageIDREl = document.getElementById('pageIDR');
    const pageVIEl  = document.getElementById('pageVI');
    const pageTHBEl = document.getElementById('pageTHB');
    const pageABAEl = document.getElementById('pageABA');
    const loginWrap = document.getElementById('loginWrap');
    const loginBtn  = document.getElementById('loginBtn');
    const loginMsg  = document.getElementById('loginMsg');
    const emailEl   = document.getElementById('email');
    const passEl    = document.getElementById('password');
    const logoutBtn = document.getElementById('logoutBtn');
    const topbarEl2 = document.getElementById('topbar');

    const roomId = location.hash?.slice(1) || "global";

    let unsubInputs=null,   unsubEntries=null;
    let unsubInputsVI=null, unsubEntriesVI=null;
    let unsubInputsTHB=null,unsubEntriesTHB=null;
    let unsubInputsABA=null,unsubEntriesABA=null;

    function showPage(which){
      if(!window.isAuthed) return;
      document.getElementById('tabIDR').classList.remove('active');
      document.getElementById('tabVI').classList.remove('active');
      document.getElementById('tabTHB').classList.remove('active');
      document.getElementById('tabABA').classList.remove('active');
      pageIDREl.hidden=true; pageVIEl.hidden=true; pageTHBEl.hidden=true; pageABAEl.hidden=true;
      if(which==='IDR'){ document.getElementById('tabIDR').classList.add('active'); pageIDREl.hidden=false; }
      else if(which==='VI'){ document.getElementById('tabVI').classList.add('active'); pageVIEl.hidden=false; }
      else if(which==='THB'){ document.getElementById('tabTHB').classList.add('active'); pageTHBEl.hidden=false; }
      else { document.getElementById('tabABA').classList.add('active'); pageABAEl.hidden=false; }
      document.body.setAttribute('data-ab-active', which==='ABA' ? '1' : '0');
    }
    document.getElementById('tabIDR').addEventListener('click',()=>showPage('IDR'));
    document.getElementById('tabVI').addEventListener('click',()=>showPage('VI'));
    document.getElementById('tabTHB').addEventListener('click',()=>showPage('THB'));
    document.getElementById('tabABA').addEventListener('click',()=>showPage('ABA'));

    loginBtn.onclick = async () => {
      loginMsg.textContent = "";
      try {
        if (!emailEl.value || !passEl.value) { loginMsg.textContent = "Nhập email và mật khẩu."; return; }
        await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
      } catch (e) { loginMsg.textContent = e?.code?.replace("auth/","") || "Đăng nhập thất bại"; }
    };
    logoutBtn.onclick = () => { const email=(auth&&auth.currentUser&&auth.currentUser.email)?` (${auth.currentUser.email})`:''; if(!confirm(`Đăng xuất${email}?`)) return; signOut(auth); };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Show app
        window.isAuthed = true;
        loginWrap.style.display = "none";
        topbarEl2.hidden = false;

        pageIDREl.hidden=false; pageVIEl.hidden=true; pageTHBEl.hidden=true; pageABAEl.hidden=true;

        appEl.hidden=false;   appEl.style.display="flex";
        appVIEl.hidden=false; appVIEl.style.display="flex";
        appTHBEl.hidden=false;appTHBEl.style.display="flex";
        appABAEl.hidden=false;appABAEl.style.display="flex";
        logoutBtn.hidden=false;

        statusEl.classList.remove('sync-warn','sync-err'); statusEl.classList.add('sync-ok');
        statusEl.textContent = '🔄'; statusEl.title = 'Realtime';

        attachRealtime_IDR(user);
        attachRealtime_VI(user);
        attachRealtime_THB(user);
        attachRealtime_ABA_inputs(user); // ABA: sync input
        attachRealtime_ABA_entries(user); // ABA: sync lịch sử + done
      } else {
        // Hide app
        window.isAuthed = false;
        topbarEl2.hidden = true;
        pageIDREl.hidden=true; pageVIEl.hidden=true; pageTHBEl.hidden=true; pageABAEl.hidden=true;
        appEl.hidden=true;     appEl.style.display="none";
        appVIEl.hidden=true;   appVIEl.style.display="none";
        appTHBEl.hidden=true;  appTHBEl.style.display="none";
        appABAEl.hidden=true;  appABAEl.style.display="none";
        logoutBtn.hidden=true;
        loginWrap.style.display="flex";

        statusEl.classList.remove('sync-ok','sync-err'); statusEl.classList.add('sync-warn');
        statusEl.textContent = '🔄'; statusEl.title = 'Local only';

        detachRealtimeAll();
      }
    });

    function detachRealtimeAll(){
      [unsubEntries,unsubInputs,unsubEntriesVI,unsubInputsVI,unsubEntriesTHB,unsubInputsTHB,unsubInputsABA,unsubEntriesABA].forEach(fn=>{ if(typeof fn==='function') fn(); });
      unsubEntries=null;unsubInputs=null;unsubEntriesVI=null;unsubInputsVI=null;unsubEntriesTHB=null;unsubInputsTHB=null;unsubInputsABA=null;unsubEntriesABA=null;
    }

    /* ==== IDR realtime ==== */
    function attachRealtime_IDR(user){
      if (typeof unsubInputs === 'function') unsubInputs();
      if (typeof unsubEntries === 'function') unsubEntries();

      const inputsRef  = ref(db, `users/${user.uid}/rooms/${roomId}/inputs`);
      const entriesRef = ref(db, `users/${user.uid}/rooms/${roomId}/entries`);
      const ids=['rateU','rateABA','usdt_input','aba_input','idr_usdt_input','idr_aba_input'];
      let applying=false;
      function readInputs(){const o={};ids.forEach(id=>o[id]=document.getElementById(id)?.value||"");return o;}
      function saveInputs(){if(applying)return;set(inputsRef,readInputs());}
      ids.forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('input',()=>setTimeout(saveInputs,120));});
      unsubInputs = onValue(inputsRef,s=>{const v=s.val();if(!v)return;applying=true;ids.forEach(id=>{const el=document.getElementById(id);if(el&&typeof v[id]!=="undefined"&&el.value!==v[id])el.value=v[id]??"";});applying=false;if(typeof window.calculate==='function')window.calculate();});

      const historyEl=document.getElementById('history'); const doneEl=document.getElementById('doneList');
      function makeActiveEntry(key,e){
        const entry=document.createElement("div");entry.className="history-entry";entry.dataset.key=key;
        const header=document.createElement("div");header.className="entry-header";
        const name=document.createElement("input");name.type="text";name.placeholder="Tên giao dịch";name.value=e.name||"";name.autocomplete="off";name.spellcheck=false;name.autocapitalize="off";
        let tmr=null;
        name.addEventListener('input',()=>{clearTimeout(tmr);tmr=setTimeout(()=>{update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{name:name.value});},600);});
        name.addEventListener('blur',()=>{update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{name:name.value});});
        const date=document.createElement("span");date.textContent=e.date||"";
        const doneBtn=document.createElement("button");doneBtn.className="done-btn";doneBtn.textContent="Duyệt";
        const del=document.createElement("button");del.className="delete-btn";del.textContent="Xóa";del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'mục này'))).toString().slice(0,80); if(!confirm('Xóa “'+__label+'”?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`)) };
        doneBtn.onclick=()=>{ const __label=(name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'mục này')).toString().slice(0,80); if(!confirm('Duyệt “'+__label+'”?')) return; const lines=[...entry.querySelectorAll('.entry-content span')].map(s=>s.textContent);update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{status:'done',name:name.value||"",content:(e.content||lines.join("\n"))});};
        header.append(name,date,doneBtn,del);
        const content=document.createElement("div");content.className="entry-content";content.style.marginTop="8px";
        (e.lines||[]).forEach((line,i)=>{if(!line?.trim())return;const lc=document.createElement("div");const tick=document.createElement("input");tick.type="checkbox";tick.style.marginRight="8px";const span=document.createElement("span");span.textContent=line;tick.checked=!!(e.ticks&&e.ticks[i]);if(tick.checked)span.classList.add('highlighted');tick.addEventListener('change',()=>{const ticks=[];content.querySelectorAll('input[type="checkbox"]').forEach(ch=>ticks.push(ch.checked));update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{ticks});span.classList.toggle('highlighted',tick.checked);});lc.append(tick,span);content.appendChild(lc);});
        entry.append(header,content);historyEl.appendChild(entry);
      }
      function makeDoneEntry(key,e){
        const entry=document.createElement("div");entry.className="history-entry done-entry";entry.dataset.key=key;
        const header=document.createElement("div");header.className="entry-header";
        const nameInput=document.createElement("input");nameInput.type="text";nameInput.value=e.name||"";nameInput.style.fontWeight="bold";nameInput.style.color="#155724";nameInput.readOnly=true;nameInput.autocomplete="off";nameInput.spellcheck=false;nameInput.autocapitalize="off";
        const editBtn=document.createElement("button");editBtn.className="edit-btn";editBtn.textContent="Chỉnh sửa";
        const del=document.createElement("button");del.className="delete-btn";del.textContent="Xóa";del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'mục này'))).toString().slice(0,80); if(!confirm('Xóa “'+__label+'”?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`)) };
        header.append(nameInput,editBtn,del);
        const textarea=document.createElement("textarea");textarea.style.cssText="width:100%;margin-top:8px;font-family:monospace;font-size:14px;border-radius:6px;border:1px solid #ccc;resize:vertical;display:none;";textarea.value=e.content||(e.lines||[]).join("\n");
        const display=document.createElement("div");display.style.cssText="white-space:pre-wrap;color:#155724;font-weight:bold;margin-top:8px;";display.textContent=textarea.value;
        editBtn.onclick=()=>{const editing=textarea.style.display==="block";if(!editing){textarea.style.display="block";display.style.display="none";editBtn.textContent="Lưu";nameInput.readOnly=false;nameInput.focus();}else{textarea.style.display="none";display.style.display="block";display.textContent=textarea.value;editBtn.textContent="Chỉnh sửa";nameInput.readOnly=true;update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{name:nameInput.value,content:textarea.value});}};
        entry.append(header,display,textarea);document.getElementById('doneList').appendChild(entry);
      }
      function renderAll(data){
        const historyEl=document.getElementById('history'); const doneEl=document.getElementById('doneList');
        historyEl.innerHTML="";doneEl.innerHTML="";
        const arr=data?Object.entries(data):[];
        arr.sort((a,b)=>(b[1]?.createdAt||0)-(a[1]?.createdAt||0));
        for(const[Key,e]of arr){(e.status==='done'?makeDoneEntry:makeActiveEntry)(Key,e);}
      }
      unsubEntries = onValue(entriesRef, s=>renderAll(s.val()));

      // bind push/clear cho IDR
      window.addToHistory=function(){
        const logText=document.getElementById("log").innerText.trim();
        if(!logText||logText==="Không có dữ liệu."||logText==="Không tìm thấy tỷ giá.")return;
        const lines=logText.split('\n').filter(l=>l.trim()!=="");
        push(ref(db,`users/${user.uid}/rooms/${roomId}/entries`),{name:"",date:`${getToday()} ${getCurrentTime()}`,lines,ticks:new Array(lines.length).fill(false),status:"active",createdAt:Date.now()});
        showToast('Đã thêm vào lịch sử');
      }
      window.clearHistory=function(){if(!confirm("Bạn có chắc muốn xóa toàn bộ lịch sử?"))return;set(ref(db,`users/${user.uid}/rooms/${roomId}/entries`),null);}
    }

    /* ==== VI realtime ==== */
    function attachRealtime_VI(user){
      if (typeof unsubInputsVI === 'function') unsubInputsVI();
      if (typeof unsubEntriesVI === 'function') unsubEntriesVI();

      const inputsRef  = ref(db, `users/${user.uid}/rooms/${roomId}/inputsVI`);
      const entriesRef = ref(db, `users/${user.uid}/rooms/${roomId}/entriesVI`);
      const ids=['rateVI','vi_input','u_input_vi'];
      let applying=false;
      function readInputs(){const o={};ids.forEach(id=>o[id]=document.getElementById(id)?.value||"");return o;}
      function saveInputs(){if(applying)return;set(inputsRef,readInputs());}
      ids.forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('input',()=>setTimeout(saveInputs,120));});
      unsubInputsVI = onValue(inputsRef,s=>{const v=s.val();if(!v)return;applying=true;ids.forEach(id=>{const el=document.getElementById(id);if(el&&typeof v[id]!=="undefined"&&el.value!==v[id])el.value=v[id]??"";});applying=false;if(typeof window.calculateVI==='function')window.calculateVI();});

      const historyEl=document.getElementById('historyVI'); const doneEl=document.getElementById('doneListVI');
      function makeActiveEntry(key,e){
        const entry=document.createElement("div");entry.className="history-entry";entry.dataset.key=key;
        const header=document.createElement("div");header.className="entry-header";
        const name=document.createElement("input");name.type="text";name.placeholder="Tên giao dịch";name.value=e.name||"";name.autocomplete="off";name.spellcheck=false;name.autocapitalize="off";
        let tmr=null;
        name.addEventListener('input',()=>{clearTimeout(tmr);tmr=setTimeout(()=>{update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`),{name:name.value});},600);});
        name.addEventListener('blur',()=>{update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`),{name:name.value});});
        const date=document.createElement("span");date.textContent=e.date||"";
        const doneBtn=document.createElement("button");doneBtn.className="done-btn";doneBtn.textContent="Duyệt";
        const del=document.createElement("button");del.className="delete-btn";del.textContent="Xóa";del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'mục này'))).toString().slice(0,80); if(!confirm('Xóa “'+__label+'”?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`)) };
        doneBtn.onclick=()=>{ const __label=(name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'mục này')).toString().slice(0,80); if(!confirm('Duyệt “'+__label+'”?')) return; const lines=[...entry.querySelectorAll('.entry-content span')].map(s=>s.textContent);update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`),{status:'done',name:name.value||"",content:(e.content||lines.join("\n"))});};
        header.append(name,date,doneBtn,del);
        const content=document.createElement("div");content.className="entry-content";content.style.marginTop="8px";
        (e.lines||[]).forEach((line,i)=>{if(!line?.trim())return;const lc=document.createElement("div");const tick=document.createElement("input");tick.type="checkbox";tick.style.marginRight="8px";const span=document.createElement("span");span.textContent=line;tick.checked=!!(e.ticks&&e.ticks[i]);if(tick.checked)span.classList.add('highlighted');tick.addEventListener('change',()=>{const ticks=[];content.querySelectorAll('input[type="checkbox"]').forEach(ch=>ticks.push(ch.checked));update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`),{ticks});span.classList.toggle('highlighted',tick.checked);});lc.append(tick,span);content.appendChild(lc);});
        entry.append(header,content);historyEl.appendChild(entry);
      }
      function makeDoneEntry(key,e){
        const entry=document.createElement("div");entry.className="history-entry done-entry";entry.dataset.key=key;
        const header=document.createElement("div");header.className="entry-header";
        const nameInput=document.createElement("input");nameInput.type="text";nameInput.value=e.name||"";nameInput.style.fontWeight="bold";nameInput.style.color="#155724";nameInput.readOnly=true;nameInput.autocomplete="off";nameInput.spellcheck=false;nameInput.autocapitalize="off";
        const editBtn=document.createElement("button");editBtn.className="edit-btn";editBtn.textContent="Chỉnh sửa";
        const del=document.createElement("button");del.className="delete-btn";del.textContent="Xóa";del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'mục này'))).toString().slice(0,80); if(!confirm('Xóa “'+__label+'”?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`)) };
        header.append(nameInput,editBtn,del);
        const textarea=document.createElement("textarea");textarea.style.cssText="width:100%;margin-top:8px;font-family:monospace;font-size:14px;border-radius:6px;border:1px solid #ccc;resize:vertical;display:none;";textarea.value=e.content||(e.lines||[]).join("\n");
        const display=document.createElement("div");display.style.cssText="white-space:pre-wrap;color:#155724;font-weight:bold;margin-top:8px;";display.textContent=textarea.value;
        editBtn.onclick=()=>{const editing=textarea.style.display==="block";if(!editing){textarea.style.display="block";display.style.display="none";editBtn.textContent="Lưu";nameInput.readOnly=false;nameInput.focus();}else{textarea.style.display="none";display.style.display="block";display.textContent=textarea.value;editBtn.textContent="Chỉnh sửa";nameInput.readOnly=true;update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`),{name:nameInput.value,content:textarea.value});}};
        entry.append(header,display,textarea);document.getElementById('doneListVI').appendChild(entry);
      }
      function renderAll(data){
        const historyEl=document.getElementById('historyVI'); const doneEl=document.getElementById('doneListVI');
        historyEl.innerHTML="";doneEl.innerHTML="";
        const arr=data?Object.entries(data):[];
        arr.sort((a,b)=>(b[1]?.createdAt||0)-(a[1]?.createdAt||0));
        for(const[Key,e]of arr){(e.status==='done'?makeDoneEntry:makeActiveEntry)(Key,e);}
      }
      unsubEntriesVI = onValue(entriesRef, s=>renderAll(s.val()));

      window.addToHistoryVI = function(){
        const logText=document.getElementById("logVI").innerText.trim();
        if(!logText||logText==="Không có dữ liệu."||logText==="Không tìm thấy tỷ giá.")return;
        const lines=logText.split('\n').filter(l=>l.trim()!=="");
        push(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI`),{name:"",date:`${getToday()} ${getCurrentTime()}`,lines,ticks:new Array(lines.length).fill(false),status:"active",createdAt:Date.now()});
        showToast('Đã thêm vào lịch sử');
      }
      window.clearHistoryVI = function(){ if(!confirm("Bạn có chắc muốn xóa toàn bộ lịch sử?"))return; set(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI`),null); }
    }

    /* ==== THB realtime ==== */
    function attachRealtime_THB(user){
      if (typeof unsubInputsTHB === 'function') unsubInputsTHB();
      if (typeof unsubEntriesTHB === 'function') unsubEntriesTHB();

      const inputsRef  = ref(db, `users/${user.uid}/rooms/${roomId}/inputsTHB`);
      const entriesRef = ref(db, `users/${user.uid}/rooms/${roomId}/entriesTHB`);
      const ids=['rateTHB','thb_input','u_input_thb'];
      let applying=false;
      function readInputs(){const o={};ids.forEach(id=>o[id]=document.getElementById(id)?.value||"");return o;}
      function saveInputs(){if(applying)return;set(inputsRef,readInputs());}
      ids.forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('input',()=>setTimeout(saveInputs,120));});
      unsubInputsTHB = onValue(inputsRef,s=>{const v=s.val();if(!v)return;applying=true;ids.forEach(id=>{const el=document.getElementById(id);if(el&&typeof v[id]!=="undefined"&&el.value!==v[id])el.value=v[id]??"";});applying=false;if(typeof window.calculateTHB==='function')window.calculateTHB();});

      const historyEl=document.getElementById('historyTHB'); const doneEl=document.getElementById('doneListTHB');
      function makeActiveEntry(key,e){
        const entry=document.createElement("div");entry.className="history-entry";entry.dataset.key=key;
        const header=document.createElement("div");header.className="entry-header";
        const name=document.createElement("input");name.type="text";name.placeholder="Tên giao dịch";name.value=e.name||"";name.autocomplete="off";name.spellcheck=false;name.autocapitalize="off";
        let tmr=null;
        name.addEventListener('input',()=>{clearTimeout(tmr);tmr=setTimeout(()=>{update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`),{name:name.value});},600);});
        name.addEventListener('blur',()=>{update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`),{name:name.value});});
        const date=document.createElement("span");date.textContent=e.date||"";
        const doneBtn=document.createElement("button");doneBtn.className="done-btn";doneBtn.textContent="Duyệt";
        const del=document.createElement("button");del.className="delete-btn";del.textContent="Xóa";del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'mục này'))).toString().slice(0,80); if(!confirm('Xóa “'+__label+'”?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`)) };
        doneBtn.onclick=()=>{ const __label=(name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'mục này')).toString().slice(0,80); if(!confirm('Duyệt “'+__label+'”?')) return; const lines=[...entry.querySelectorAll('.entry-content span')].map(s=>s.textContent);update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`),{status:'done',name:name.value||"",content:(e.content||lines.join("\n"))});};
        header.append(name,date,doneBtn,del);
        const content=document.createElement("div");content.className="entry-content";content.style.marginTop="8px";
        (e.lines||[]).forEach((line,i)=>{if(!line?.trim())return;const lc=document.createElement("div");const tick=document.createElement("input");tick.type="checkbox";tick.style.marginRight="8px";const span=document.createElement("span");span.textContent=line;tick.checked=!!(e.ticks&&e.ticks[i]);if(tick.checked)span.classList.add('highlighted');tick.addEventListener('change',()=>{const ticks=[];content.querySelectorAll('input[type="checkbox"]').forEach(ch=>ticks.push(ch.checked));update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`),{ticks});span.classList.toggle('highlighted',tick.checked);});lc.append(tick,span);content.appendChild(lc);});
        entry.append(header,content);historyEl.appendChild(entry);
      }
      function makeDoneEntry(key,e){
        const entry=document.createElement("div");entry.className="history-entry done-entry";entry.dataset.key=key;
        const header=document.createElement("div");header.className="entry-header";
        const nameInput=document.createElement("input");nameInput.type="text";nameInput.value=e.name||"";nameInput.style.fontWeight="bold";nameInput.style.color="#155724";nameInput.readOnly=true;nameInput.autocomplete="off";nameInput.spellcheck=false;nameInput.autocapitalize="off";
        const editBtn=document.createElement("button");editBtn.className="edit-btn";editBtn.textContent="Chỉnh sửa";
        const del=document.createElement("button");del.className="delete-btn";del.textContent="Xóa";del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'mục này'))).toString().slice(0,80); if(!confirm('Xóa “'+__label+'”?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`)) };
        header.append(nameInput,editBtn,del);
        const textarea=document.createElement("textarea");textarea.style.cssText="width:100%;margin-top:8px;font-family:monospace;font-size:14px;border-radius:6px;border:1px solid #ccc;resize:vertical;display:none;";textarea.value=e.content||(e.lines||[]).join("\n");
        const display=document.createElement("div");display.style.cssText="white-space:pre-wrap;color:#155724;font-weight:bold;margin-top:8px;";display.textContent=textarea.value;
        editBtn.onclick=()=>{const editing=textarea.style.display==="block";if(!editing){textarea.style.display="block";display.style.display="none";editBtn.textContent="Lưu";nameInput.readOnly=false;nameInput.focus();}else{textarea.style.display="none";display.style.display="block";display.textContent=textarea.value;editBtn.textContent="Chỉnh sửa";nameInput.readOnly=true;update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`),{name:nameInput.value,content:textarea.value});}};
        entry.append(header,display,textarea);document.getElementById('doneListTHB').appendChild(entry);
      }
      function renderAll(data){
        const historyEl=document.getElementById('historyTHB'); const doneEl=document.getElementById('doneListTHB');
        historyEl.innerHTML="";doneEl.innerHTML="";
        const arr=data?Object.entries(data):[];
        arr.sort((a,b)=>(b[1]?.createdAt||0)-(a[1]?.createdAt||0));
        for(const[Key,e]of arr){(e.status==='done'?makeDoneEntry:makeActiveEntry)(Key,e);}
      }
      unsubEntriesTHB = onValue(entriesRef, s=>renderAll(s.val()));

      window.addToHistoryTHB = function(){
        const logText=document.getElementById("logTHB").innerText.trim();
        if(!logText||logText==="Không có dữ liệu."||logText==="Không tìm thấy tỷ giá.")return;
        const lines=logText.split('\n').filter(l=>l.trim()!=="");
        push(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB`),{name:"",date:`${getToday()} ${getCurrentTime()}`,lines,ticks:new Array(lines.length).fill(false),status:"active",createdAt:Date.now()});
        showToast('Đã thêm vào lịch sử');
      }
      window.clearHistoryTHB = function(){ if(!confirm("Bạn có chắc muốn xóa toàn bộ lịch sử?"))return; set(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB`),null); }
    }

    /* ==== ABA realtime: inputs (giữ nguyên) ==== */
    function attachRealtime_ABA_inputs(user){
      if (typeof unsubInputsABA === 'function') unsubInputsABA();
      const inputsRef  = ref(db, `users/${user.uid}/rooms/${roomId}/inputsABA`);
      const ids=['rateABA4','amountABA'];
      let applying=false;
      function readInputs(){const o={};ids.forEach(id=>o[id]=document.getElementById(id)?.value||"");return o;}
      function saveInputs(){if(applying)return;set(inputsRef,readInputs());}
      ids.forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('input',()=>setTimeout(saveInputs,120));});
      unsubInputsABA = onValue(inputsRef,s=>{const v=s.val(); if(!v) return; applying=true; ids.forEach(id=>{const el=document.getElementById(id); if(el && typeof v[id]!=="undefined" && el.value!==v[id]) el.value=v[id]??"";}); applying=false; if(typeof window.calculateABA==='function') window.calculateABA();});
    }

    /* ==== ABA realtime (entries) ==== */
    function attachRealtime_ABA_entries(user){
      if (typeof unsubEntriesABA === 'function') unsubEntriesABA();

      const entriesRef = ref(db, `users/${user.uid}/rooms/${roomId}/entriesABA`);
      const historyEl=document.getElementById('historyABA');
      const doneEl=document.getElementById('doneListABA');

      function makeActiveEntry(key,e){
        const entry=document.createElement("div"); entry.className="history-entry"; entry.dataset.key=key;
        const header=document.createElement("div"); header.className="entry-header";
        const name=document.createElement("input"); name.type="text"; name.placeholder="Tên giao dịch"; name.value=e.name||""; name.autocomplete="off"; name.spellcheck=false; name.autocapitalize="off";
        let tmr=null;
        name.addEventListener('input',()=>{ clearTimeout(tmr); tmr=setTimeout(()=>{ update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`), {name:name.value}); },600); });
        name.addEventListener('blur',()=>{ update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`), {name:name.value}); });
        const date=document.createElement("span"); date.textContent=e.date||"";
        const doneBtn=document.createElement("button"); doneBtn.className="done-btn"; doneBtn.textContent="Duyệt";
        const del=document.createElement("button"); del.className="delete-btn"; del.textContent="Xóa"; del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'mục này'))).toString().slice(0,80); if(!confirm('Xóa “'+__label+'”?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`)) };
        doneBtn.onclick=()=>{ const __label=(name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'mục này')).toString().slice(0,80); if(!confirm('Duyệt “'+__label+'”?')) return;  const lines=[...entry.querySelectorAll('.entry-content span')].map(s=>s.textContent); update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`), {status:'done', name:name.value||"", content:(e.content||lines.join("\n"))}); };
        header.append(name,date,doneBtn,del);

        const content=document.createElement("div"); content.className="entry-content"; content.style.marginTop="8px";
        (e.lines||[]).forEach((line,i)=>{ 
          if(!line?.trim()) return;
          const lc=document.createElement("div");
          const tick=document.createElement("input"); tick.type="checkbox"; tick.style.marginRight="8px";
          const span=document.createElement("span"); span.textContent=line;
          tick.checked=!!(e.ticks&&e.ticks[i]); if(tick.checked) span.classList.add('highlighted');
          tick.addEventListener('change',()=>{ 
            const ticks=[]; content.querySelectorAll('input[type="checkbox"]').forEach(ch=>ticks.push(ch.checked));
            update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`), {ticks});
            span.classList.toggle('highlighted',tick.checked);
          });
          lc.append(tick,span); content.appendChild(lc);
        });
        entry.append(header,content); historyEl.appendChild(entry);
      }

      function makeDoneEntry(key,e){
        const entry=document.createElement("div"); entry.className="history-entry done-entry"; entry.dataset.key=key;
        const header=document.createElement("div"); header.className="entry-header";
        const nameInput=document.createElement("input"); nameInput.type="text"; nameInput.value=e.name||""; nameInput.style.fontWeight="bold"; nameInput.style.color="#155724"; nameInput.readOnly=true; nameInput.autocomplete="off"; nameInput.spellcheck=false; nameInput.autocapitalize="off";
        const editBtn=document.createElement("button"); editBtn.className="edit-btn"; editBtn.textContent="Chỉnh sửa";
        const del=document.createElement("button"); del.className="delete-btn"; del.textContent="Xóa"; del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'mục này'))).toString().slice(0,80); if(!confirm('Xóa “'+__label+'”?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`)) };
        header.append(nameInput,editBtn,del);
        const textarea=document.createElement("textarea"); textarea.style.cssText="width:100%;margin-top:8px;font-family:monospace;font-size:14px;border-radius:6px;border:1px solid #ccc;resize:vertical;display:none;"; textarea.value=e.content||(e.lines||[]).join("\n");
        const display=document.createElement("div"); display.style.cssText="white-space:pre-wrap;color:#155724;font-weight:bold;margin-top:8px;"; display.textContent=textarea.value;
        editBtn.onclick=()=>{ 
          const editing=textarea.style.display==="block";
          if(!editing){ textarea.style.display="block"; display.style.display="none"; editBtn.textContent="Lưu"; nameInput.readOnly=false; nameInput.focus(); }
          else{ textarea.style.display="none"; display.style.display="block"; display.textContent=textarea.value; editBtn.textContent="Chỉnh sửa"; nameInput.readOnly=true; update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`), {name:nameInput.value, content:textarea.value}); }
        };
        entry.append(header,display,textarea); doneEl.appendChild(entry);
      }

      function renderAll(data){
        historyEl.innerHTML=""; doneEl.innerHTML="";
        const arr=data?Object.entries(data):[];
        arr.sort((a,b)=>(b[1]?.createdAt||0)-(a[1]?.createdAt||0));
        for(const [k,e] of arr){ (e.status==='done'?makeDoneEntry:makeActiveEntry)(k,e); }
      }
      unsubEntriesABA = onValue(entriesRef, s=>renderAll(s.val()));

      window.addToHistoryABA_U2A = function(){
        const l=document.getElementById("logABA_u2a").innerText.trim(); if(!l) return;
        const lines=l.split('\n').filter(x=>x.trim()!=='');
        push(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA`), {name:"", date:`${getToday()} ${getCurrentTime()}`, lines, ticks:new Array(lines.length).fill(false), status:"active", createdAt:Date.now(), direction:'U2A'});
        showToast('Đã thêm vào lịch sử');
      };
      window.addToHistoryABA_A2U = function(){
        const l=document.getElementById("logABA_a2u").innerText.trim(); if(!l) return;
        const lines=l.split('\n').filter(x=>x.trim()!=='');
        push(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA`), {name:"", date:`${getToday()} ${getCurrentTime()}`, lines, ticks:new Array(lines.length).fill(false), status:"active", createdAt:Date.now(), direction:'A2U'});
        showToast('Đã thêm vào lịch sử');
      };
      window.clearHistoryABA = function(){ if(!confirm('Bạn có chắc muốn xóa toàn bộ lịch sử?')) return; set(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA`), null); };
    }
  </script>

<!-- === MOBILE TYPING STABILITY HELPERS (no logic change) === -->
<script>
  (function(){
    // 1) Keep cursor stable on remote updates: if focused, don't force set .value
    const protectors = new Set();
    function markTyping(e){
      const el = e.target;
      protectors.add(el);
      clearTimeout(el._typingTmr);
      el._typingTmr = setTimeout(()=>protectors.delete(el), 900); // release 0.9s sau lần gõ cuối
    }
    document.addEventListener('input', markTyping, true);
    // Monkey-patch Element.prototype.value setter? Too invasive.
    // Instead, observe all programmatic value sets via attribute change + focus check:
    const origSet = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value').set;
    Object.defineProperty(HTMLInputElement.prototype, 'value', {
      set: function(v){
        // If this input is currently protected (user đang gõ), ignore identical set to avoid caret jump
        if (document.activeElement === this && protectors.has(this)) {
          if (String(this.value) === String(v)) return; // skip no-op
        }
        return origSet.call(this, v);
      }
    });

    // 2) Center focused input to avoid keyboard che đè & mất focus
    function scrollIntoViewCentered(el){
      try{
        const r = el.getBoundingClientRect();
        if (r.top < 80 || r.bottom > (window.innerHeight - 120)) {
          el.scrollIntoView({ block: 'center', behavior: 'smooth' });
        }
      }catch{}
    }
    document.addEventListener('focus', (e)=>{
      const el = e.target;
      if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')) {
        setTimeout(()=>scrollIntoViewCentered(el), 220);
      }
    }, true);

    // 3) Prevent iOS auto-zoom by ensuring font-size >= 16px (already in CSS), and lock viewport fit
    try {
      const vp = document.querySelector('meta[name="viewport"]');
      if (vp && !/viewport-fit=cover/.test(vp.content)) {
        vp.content = vp.content + ', viewport-fit=cover';
      }
    } catch {}

  })();
</script>


<!-- === Inject brand pill + tab icons; keep logic intact === -->
<script id="wow-brand-js">
(function(){
  // 1) Brand pill
  try{
    const topbar = document.querySelector('.topbar') || document.querySelector('header');
    if (topbar && !topbar.querySelector('.brand-pill')){
      const pill = document.createElement('div');
      pill.className = 'brand-pill';
      pill.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 12h18M12 3v18" stroke="#0b1220" stroke-opacity=".25" stroke-width="3"/><circle cx="12" cy="12" r="7" fill="white" fill-opacity=".9"/></svg><span>FX • Ledger</span>';
      topbar.prepend(pill);
    }
  }catch{}

  // 2) Icons per tab by text content
  const ICONS = { "IDR":"Rp", "VI":"₫", "VND":"₫", "THB":"฿", "ABA":"A" };
  document.querySelectorAll('.tab').forEach(el => {
    const text = (el.textContent || '').trim().toUpperCase();
    const key = ICONS[text] ? text : (["IDR","VI","VND","THB","ABA"].find(k => text.includes(k)) || "");
    if (key && !el.dataset.ico){
      el.dataset.ico = ICONS[key];
    }
  });

  // 3) Add timeline class to known history blocks (purely cosmetic)
  document.querySelectorAll('.history, .historyVI, .historyTHB, .historyABA').forEach(h => {
    h.classList.add('timeline');
  });
})();
</script>


<!-- === ULTRA WOW JS helpers (decorative only) === -->
<script id="wow-ultra-js">
(function(){
  // 1) Ripple effect on buttons (purely visual)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn');
    if(!btn) return;
    // Create ripple
    const r = btn.getBoundingClientRect();
    const x = e.clientX - r.left, y = e.clientY - r.top;
    const rip = document.createElement('span');
    rip.className = 'ripple';
    rip.style.left = (x-10)+'px';
    rip.style.top = (y-10)+'px';
    btn.appendChild(rip);
    setTimeout(()=>rip.remove(), 650);
  }, true);

  // 2) Add icons to typical buttons by their text content (non-invasive)
  const MAP = [
    { text: "Duyệt", icon: "✓" },
    { text: "Xóa", icon: "🗑" },
    { text: "Xoá", icon: "🗑" },
    { text: "Chỉnh sửa", icon: "✎" },
    { text: "Đăng xuất", icon: "↩" },
  ];
  function decorate(){
    document.querySelectorAll('.btn').forEach(b=>{
      const t = (b.textContent||"").trim();
      const m = MAP.find(x=> t === x.text);
      if(m && !b.dataset.icon){ b.dataset.icon = m.icon; }
    });
  }
  decorate();
  const mo = new MutationObserver(decorate);
  mo.observe(document.body, { childList:true, subtree:true, characterData:true });

  // 3) Vibrate subtly on destructive action on mobile (UI feedback; safe & optional)
  document.addEventListener('click', function(e){
    const danger = e.target.closest('.btn.danger, .delete-btn');
    if(danger && navigator.vibrate){ navigator.vibrate(10); }
  }, true);
})();
</script>


<script id="wow-patch-brand-tabs">
(function(){
  // 1) Rename brand pill text to "Calculator"
  try{
    var pill = document.querySelector('.brand-pill');
    if (pill){
      pill.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 4h16v16H4z" stroke="#0b1220" stroke-opacity=".25" stroke-width="2"/><path d="M7 8h10M7 12h10M7 16h6" stroke="white" stroke-width="2" stroke-linecap="round"/></svg><span>Calculator</span>';
    }
  }catch(e){}
  // 2) Remove dataset icons from tabs (cleanup)
  document.querySelectorAll('.tab').forEach(function(el){
    if (el.hasAttribute('data-ico')) el.removeAttribute('data-ico');
  });
})();
</script>


<script id="wow-strong-focus-lock">
(function(){
  // Detect "user is intentionally changing focus"
  let userPointer = false, pointerTimer = 0;
  function allowBlurFor(){ userPointer = true; clearTimeout(pointerTimer); pointerTimer = setTimeout(()=>userPointer=false, 450); }
  document.addEventListener('mousedown', allowBlurFor, true);
  document.addEventListener('touchstart', allowBlurFor, {passive:true, capture:true});
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Tab' || e.key === 'Escape') allowBlurFor(); }, true);

  // Track current editable and caret
  let current = null;
  let caret = null; // [start,end] for inputs, Range for contenteditable

  function isEditable(el){
    if (!el) return false;
    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') return true;
    if (el.isContentEditable) return true;
    return false;
  }

  function saveCaret(){
    if (!current) return;
    if (current.tagName === 'INPUT' || current.tagName === 'TEXTAREA'){
      try { caret = [current.selectionStart, current.selectionEnd]; } catch {}
    } else if (current.isContentEditable){
      try {
        const sel = window.getSelection();
        if (sel && sel.rangeCount) caret = sel.getRangeAt(0).cloneRange();
      } catch {}
    }
  }

  function restoreCaret(el){
    try{
      if (!el) return;
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA'){
        el.focus({preventScroll:true});
        if (caret && typeof caret[0] === 'number' && typeof el.setSelectionRange === 'function'){
          el.setSelectionRange(caret[0], caret[1] ?? caret[0]);
        }
      } else if (el.isContentEditable){
        el.focus({preventScroll:true});
        const sel = window.getSelection();
        sel.removeAllRanges();
        if (caret && caret.cloneRange){
          // Try existing saved range
          try { sel.addRange(caret.cloneRange()); return; } catch {}
        }
        // Fallback: place at end
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        sel.addRange(range);
      }
    }catch{}
  }

  document.addEventListener('focusin', (e)=>{
    if (!isEditable(e.target)) return;
    current = e.target;
    saveCaret();
  }, true);

  document.addEventListener('selectionchange', ()=>{
    if (document.activeElement === current) saveCaret();
  });

  document.addEventListener('compositionstart', ()=>{ if(current) current.dataset.typing = "1"; }, true);
  document.addEventListener('compositionend',   ()=>{ if(current) delete current.dataset.typing; }, true);

  // If blur happens without user intent, immediately restore focus
  document.addEventListener('blur', (e)=>{
    const el = e.target;
    if (!isEditable(el)) return;
    // If user clicked elsewhere or tabbed, allow blur
    if (userPointer) return;
    // If tab lost visibility (e.g., switch apps), don't fight it
    if (document.visibilityState === 'hidden') return;

    // Refocus shortly after potential DOM diff
    setTimeout(()=>{
      if (document.activeElement && document.activeElement !== document.body) return;
      // Find equivalent element
      let target = el.isConnected ? el : (el.id && document.getElementById(el.id)) ||
                  (el.name && document.querySelector(`[name="${el.name}"]`)) ||
                  null;
      if (!target && current) target = current.isConnected ? current : target;
      if (target) restoreCaret(target);
    }, 60);
  }, true);

  // Observe DOM mutations; if current editable disappears due to re-render, restore
  const mo = new MutationObserver(()=>{
    if (!current || userPointer) return;
    if (!current.isConnected || document.activeElement === document.body){
      let target = current.isConnected ? current : (current.id && document.getElementById(current.id)) ||
                  (current.name && document.querySelector(`[name="${current.name}"]`)) || null;
      if (target) restoreCaret(target);
    }
  });
  mo.observe(document.body, { childList:true, subtree:true });
})();
</script>


<script id="wow-strong-focus-lock-v2">
(function(){
  // ----- user intent detector -----
  let userIntent = false, intentTimer = 0;
  function markIntent(){ userIntent = true; clearTimeout(intentTimer); intentTimer = setTimeout(()=>userIntent=false, 500); }
  document.addEventListener('mousedown', markIntent, true);
  document.addEventListener('touchstart', markIntent, {passive:true, capture:true});
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Tab' || e.key === 'Escape') markIntent(); }, true);

  // ----- track focused element and caret -----
  let current = null;
  let caret = null;

  function isEditable(el){
    return !!el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable);
  }

  function saveCaret(){
    if (!current) return;
    if (current.tagName === 'INPUT' || current.tagName === 'TEXTAREA'){
      try { caret = [current.selectionStart, current.selectionEnd]; } catch {}
    } else if (current.isContentEditable){
      try { const sel = getSelection(); if (sel && sel.rangeCount) caret = sel.getRangeAt(0).cloneRange(); } catch {}
    }
  }

  function restoreCaret(el){
    if (!el) return;
    try{
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA'){
        el.focus({preventScroll:true});
        if (caret && typeof caret[0] === 'number' && typeof el.setSelectionRange === 'function'){
          el.setSelectionRange(caret[0], caret[1] ?? caret[0]);
        }
      } else if (el.isContentEditable){
        el.focus({preventScroll:true});
        const sel = getSelection();
        sel.removeAllRanges();
        if (caret && caret.cloneRange){ try{ sel.addRange(caret.cloneRange()); return; }catch{} }
        const r = document.createRange(); r.selectNodeContents(el); r.collapse(false); sel.addRange(r);
      }
    }catch{}
  }

  // fingerprint via path for locating equivalent element after rerender
  function pathFor(el){
    if (!el) return "";
    if (el.id) return `#${CSS.escape(el.id)}`;
    if (el.name) return `${el.tagName.toLowerCase()}[name="${el.name}"]`;
    // build nth-child path up to the nearest form/section/container
    let node = el, parts = [];
    let depth = 0;
    while (node && node !== document.body && depth < 6){
      let idx = 1, sib = node;
      while (sib = sib.previousElementSibling){ if (sib.tagName === node.tagName) idx++; }
      parts.unshift(`${node.tagName.toLowerCase()}:nth-of-type(${idx})`);
      node = node.parentElement;
      depth++;
      if (node && (node.tagName === 'FORM' || node.classList.contains('container') || node.classList.contains('card'))) break;
    }
    return parts.length ? parts.join(" > ") : "";
  }

  let focusPath = "";
  document.addEventListener('focusin', (e)=>{
    if (!isEditable(e.target)) return;
    current = e.target;
    focusPath = pathFor(current);
    saveCaret();
  }, true);

  document.addEventListener('selectionchange', ()=>{
    if (document.activeElement === current) saveCaret();
  });

  // preserve caret across programmatic value sets while typing
  try{
    const desc = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');
    const origSet = desc && desc.set;
    if (origSet){
      Object.defineProperty(HTMLInputElement.prototype, 'value', {
        set: function(v){
          const active = (document.activeElement === this);
          let hadCaret = null;
          if (active){
            try{ hadCaret = [this.selectionStart, this.selectionEnd]; }catch{}
          }
          const out = origSet.call(this, v);
          if (active && hadCaret && typeof this.setSelectionRange === 'function'){
            try{ this.setSelectionRange(hadCaret[0], hadCaret[1] ?? hadCaret[0]); }catch{}
          }
          return out;
        }
      });
    }
  }catch{}

  // resist unwanted blur
  document.addEventListener('blur', (e)=>{
    const el = e.target;
    if (!isEditable(el)) return;
    if (userIntent) return;
    if (document.visibilityState === 'hidden') return;

    setTimeout(()=>{
      if (document.activeElement && document.activeElement !== document.body) return;
      let target = (el.isConnected ? el : null);
      if (!target && focusPath){
        try{ target = document.querySelector(focusPath); }catch{}
      }
      if (!target && el.id) target = document.getElementById(el.id);
      if (!target && el.name) target = document.querySelector(`[name="${el.name}"]`);
      if (target) restoreCaret(target);
    }, 120);
  }, true);

  const mo = new MutationObserver(()=>{
    if (!current || userIntent) return;
    if (!current.isConnected || document.activeElement === document.body){
      let target = current.isConnected ? current : null;
      if (!target && focusPath){
        try{ target = document.querySelector(focusPath); }catch{}
      }
      if (!target && current.id) target = document.getElementById(current.id);
      if (!target && current.name) target = document.querySelector(`[name="${current.name}"]`);
      if (target) restoreCaret(target);
    }
  });
  mo.observe(document.body, { childList:true, subtree:true });
})();
</script>


<script id="wow-rounding-safe-js">
(function(){
  // Only add a class to the element that *only* contains the hint text.
  const SELECTORS = ['.small', '.muted', 'label', 'p', 'span'];
  const KEY = 'Làm tròn:';
  function looksLikeHint(el){
    if (!el) return false;
    if (el.childElementCount > 1) return false;     // avoid big containers
    const t = (el.textContent || '').trim();
    if (!t.includes(KEY)) return false;
    if (t.length > 40) return false;                // too long -> likely container, skip
    return true;
  }
  function enhance(){
    document.querySelectorAll(SELECTORS.join(',')).forEach(el => {
      if (el.classList && (el.classList.contains('rounding-hint') || el.classList.contains('rounding-hint-line'))) return;
      if (looksLikeHint(el)){
        el.classList.add('rounding-hint-line');
        // If line starts with 📱, keep it; else prepend a small emoji box for affordance
        const txt = (el.textContent || '').trim();
        if (!/^📱/.test(txt)){
          el.innerHTML = '<span class="emoji">📱</span> ' + el.innerHTML;
        }
      }
    });
  }
  enhance();
  const mo = new MutationObserver((ms)=>{
    let need = false;
    for (const m of ms){
      if (m.addedNodes && m.addedNodes.length) { need = true; break; }
    }
    if (need) requestAnimationFrame(enhance);
  });
  mo.observe(document.body, { childList:true, subtree:true });
})();
</script>

</body>
</html>
