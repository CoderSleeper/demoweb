<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Caculator</title>
  <style>
    [hidden]{display:none!important}
    body{font-family:Arial,sans-serif;margin:20px;background:#f0f8ff;color:#222}
    #app,#appVI,#appTHB,#appABA{display:flex;gap:30px;align-items:flex-start}
    #app[hidden],#appVI[hidden],#appTHB[hidden],#appABA[hidden]{display:none!important}
    .container{width:48%;background:#fff;border-radius:8px;box-shadow:0 0 8px rgba(0,0,0,.1);padding:20px 25px;box-sizing:border-box}
    h2,h3{margin-bottom:15px;color:#004080;border-bottom:2px solid #0080ff;padding-bottom:5px}
    label{font-weight:600;display:block;margin:15px 0 5px;color:#003366}
    input[type="text"],input[type="number"],textarea{width:100%;padding:8px 12px;border-radius:5px;border:1px solid #ccc;font-family:monospace;font-size:14px;box-sizing:border-box;transition:border-color .3s}
    input[type="text"]:focus,input[type="number"]:focus,textarea:focus{border-color:#3399ff;outline:none}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-family:monospace;font-size:15px}
    table th,table td{border:1px solid #ccc;padding:6px 10px;text-align:center;color:#004080}
    table th{background:#e6f0ff}
    table input{border:none;text-align:center;font-weight:bold;font-size:14px;width:100%;padding:4px 0;background:transparent;color:#00264d}
    table input:focus{outline:1px solid #3399ff;background:#dbe9ff}
    .btn{background:#007bff;color:#fff;border:none;border-radius:6px;padding:10px 18px;font-size:15px;cursor:pointer;margin-top:15px;margin-right:10px;transition:background-color .3s;user-select:none}
    .btn:hover{background:#0056b3}
    .btn-red{background:#dc3545;float:right;margin:0 0 15px 0}.btn-red:hover{background:#a61b2b}
    .log{margin-top:15px;background:#f9f9f9;border:1px solid #ddd;border-radius:6px;padding:12px 15px;font-family:monospace;font-size:14px;min-height:120px;white-space:pre-wrap;color:#222}
    .history,#doneList,.historyVI,#doneListVI,.historyTHB,#doneListTHB,.historyABA,#doneListABA{max-height:480px;overflow-y:auto;border:1px solid #ccc;background:#fafafa;border-radius:6px;padding:10px 12px;font-family:monospace;font-size:14px;color:#111}
    .history-entry{border-bottom:1px solid #ccc;padding:10px 8px;margin-bottom:10px;background:#fff;border-radius:5px}
    .history-entry:last-child{margin-bottom:0}
    .entry-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px}
    .entry-header input[type="text"]{flex:1;min-width:160px;padding:6px 10px;font-size:14px;border-radius:4px;border:1px solid #aaa;font-family:inherit;color:#003366}
    .entry-header span{color:#004080;font-weight:600;font-size:14px;user-select:none;white-space:nowrap}
    .entry-header button{margin-left:0;border-radius:5px;font-size:13px;padding:6px 10px;border:none;cursor:pointer;user-select:none;transition:background-color .3s}
    .delete-btn{background:#dc3545;color:#fff}.delete-btn:hover{background:#a61b2b}
    .done-btn{background:#28a745;color:#fff}.done-btn:hover{background:#1e7e34}
    .edit-btn{background:#ffc107;color:#222}.edit-btn:hover{background:#e0a800}
    .entry-content div{display:flex;align-items:center;margin-bottom:4px}
    .entry-content div span{user-select:text}
    .entry-content div input[type="checkbox"]{margin-right:8px;cursor:pointer;transform:scale(1.1)}
    .highlighted{background:#d3f4d3;font-weight:bold}
    .done-entry{border-left:4px solid #28a745;background:#e6f7e6!important;font-weight:bold!important;color:#155724!important}
    .history::-webkit-scrollbar,#doneList::-webkit-scrollbar,.historyVI::-webkit-scrollbar,#doneListVI::-webkit-scrollbar,.historyTHB::-webkit-scrollbar,#doneListTHB::-webkit-scrollbar,.historyABA::-webkit-scrollbar,#doneListABA::-webkit-scrollbar{width:8px}
    .history::-webkit-scrollbar-thumb,#doneList::-webkit-scrollbar-thumb,.historyVI::-webkit-scrollbar-thumb,#doneListVI::-webkit-scrollbar-thumb,.historyTHB::-webkit-scrollbar-thumb,#doneListTHB::-webkit-scrollbar-thumb,.historyABA::-webkit-scrollbar-thumb,#doneListABA::-webkit-scrollbar-thumb{background:#b0c4de;border-radius:4px}
    .btn-container{margin-top:15px;overflow:hidden}
    .tabs{display:inline-flex;border:1px solid #cbd5e1;border-radius:999px;overflow:hidden;background:#fff}
    .tab{padding:8px 14px;border:none;background:transparent;cursor:pointer;font-weight:600;color:#334155}
    .tab.active{background:#0b73ff;color:#fff}
    .topbar{position:fixed;left:16px;top:12px;display:flex;gap:8px;align-items:center;z-index:9999}
    .sync-badge{position:fixed;right:16px;top:12px;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,.15);font-size:16px;color:#111;z-index:9999}
    .sync-ok{background:#e6ffed}.sync-warn{background:#fff7e6}.sync-err{background:#ffe6e6}
    .auth-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#f0f8ff}
    .auth-card{width:360px;max-width:92vw;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.1);padding:20px}
    .auth-card h2{margin:0 0 12px;border:none;color:#0b4aa7}
    .auth-card .row{margin-bottom:10px}
    .auth-card input{width:100%;padding:10px 12px;border:1px solid #cdd6e0;border-radius:8px;font-size:14px}
    .auth-card button{width:100%;padding:10px 12px;border:none;border-radius:8px;background:#0b73ff;color:#fff;font-weight:600;cursor:pointer}
    .auth-msg{margin-top:8px;font-size:13px;color:#a11;min-height:18px}
    @media (max-width:992px){#app,#appVI,#appTHB,#appABA{flex-direction:column}.container{width:100%}}

    /* gi·ªØ nguy√™n style n√∫t logout nh∆∞ b·∫£n g·ªëc */
    #logoutBtn{
      position: fixed !important;
      right: 16px !important;
      bottom: 16px !important;
      z-index: 2000 !important;
      background: #ef4444 !important;
      color: #fff !important;
      border-color: #dc2626 !important;
      box-shadow: 0 6px 18px rgba(239,68,68,.35) !important;
      border-radius: 10px !important;
      padding: 10px 16px !important;
    }
    body #logoutBtn:hover{ filter: brightness(1.06); }

    /* Tiny toast (auto-hide ~2s) */
    #toast{
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.82);
      color:#fff;
      padding:6px 10px;
      border-radius:8px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
      z-index:3000;
    }
    #toast.show{opacity:1}
  </style>

</head>
<body>
  <div id="toast" aria-live="polite"></div>
  <!-- Topbar (·∫©n tr∆∞·ªõc khi login) -->
  <div id="topbar" class="topbar" hidden>
    <button id="logoutBtn" class="btn" hidden>ƒêƒÉng xu·∫•t</button>
    <div class="tabs" style="margin-left:8px;">
      <button class="tab active" id="tabIDR">I</button>
      <button class="tab" id="tabVI">V</button>
      <button class="tab" id="tabTHB">T√™</button>
      <button class="tab" id="tabABA">AB</button>
    </div>
  </div>

  <!-- Badge Sync -->
  <div id="syncStatus" class="sync-badge sync-warn" title="Local only">üîÑ</div>

  <!-- Login -->
  <div id="loginWrap" class="auth-wrap">
    <div class="auth-card">
      <h2>ƒêƒÉng nh·∫≠p</h2>
      <div class="row"><input id="email" type="email" placeholder="Email" autocomplete="off" autocapitalize="off" spellcheck="false" /></div>
      <div class="row"><input id="password" type="password" placeholder="M·∫≠t kh·∫©u" autocomplete="off" autocapitalize="off" spellcheck="false" /></div>
      <button id="loginBtn">ƒêƒÉng nh·∫≠p</button>
      <div id="loginMsg" class="auth-msg"></div>
      <div style="font-size:12px;color:#666;margin-top:6px">T√†i kho·∫£n do admin c·∫•p. Kh√¥ng m·ªü ƒëƒÉng k√Ω.</div>
    </div>
  </div>

  <!-- PAGE: IDR -->
  <div id="pageIDR" style="margin-top:60px;" hidden>
    <div id="app" hidden style="display:none">
      <div class="container">
        <h2>Caculator ‚Äî Trang "I"</h2>
        <label>T·ª∑ gi√°:</label>
        <table>
          <thead><tr><th>Lo·∫°i</th><th>T·ª∑ gi√°</th></tr></thead>
          <tbody>
            <tr><td>IDR / U</td><td><input type="number" id="rateU" placeholder="U" oninput="calculate()" autocomplete="off" autocapitalize="off" spellcheck="false" /></td></tr>
            <tr><td>IDR / ABA</td><td><input type="number" id="rateABA" placeholder="ABA" oninput="calculate()" autocomplete="off" autocapitalize="off" spellcheck="false" /></td></tr>
          </tbody>
        </table>
        <label>USDT:</label><input type="text" id="usdt_input" placeholder="VD: 1k, 1.2k, 1350.5" oninput="calculate()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <label>ABA:</label><input type="text" id="aba_input" placeholder="VD: 2k, 5000" oninput="calculate()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <label>IDR ‚ûù USDT:</label><input type="number" id="idr_usdt_input" placeholder="Nh·∫≠p IDR ƒë·ªïi USDT" oninput="calculate()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <label>IDR ‚ûù ABA:</label><input type="number" id="idr_aba_input" placeholder="Nh·∫≠p IDR ƒë·ªïi ABA" oninput="calculate()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <div class="btn-container">
          <button class="btn" onclick="copyForm()">Copy Form</button>
          <button class="btn" onclick="addToHistory()">Add v√†o l·ªãch s·ª≠</button>
        </div>
        <div class="log" id="log"></div>
      </div>
      <div class="container">
        <h3>L·ªãch s·ª≠ <button class="btn btn-red" style="float:right" onclick="clearHistory()">X√≥a to√†n b·ªô l·ªãch s·ª≠</button></h3>
        <div class="history" id="history"></div>
        <h3>ƒê√£ xong</h3>
        <div id="doneList"></div>
      </div>
    </div>
  </div>

  <!-- PAGE: VI -->
  <div id="pageVI" style="margin-top:60px;" hidden>
    <div id="appVI" hidden style="display:none">
      <div class="container">
        <h2>Caculator ‚Äî Trang "VI"</h2>
        <label>T·ª∑ gi√° VI:</label>
        <table>
          <thead><tr><th>Lo·∫°i</th><th>T·ª∑ gi√°</th></tr></thead>
          <tbody>
            <tr><td>VND / USDT</td><td><input type="number" id="rateVI" placeholder="V" oninput="calculateVI()" autocomplete="off" autocapitalize="off" spellcheck="false" /></td></tr>
          </tbody>
        </table>
        <label>Vi (VND ‚ûù USDT):</label><input type="text" id="vi_input" placeholder="VD: 1B, 5m, 2,5m" oninput="calculateVI()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <label>U (USDT ‚ûù VND):</label><input type="text" id="u_input_vi" placeholder="VD: 100, 1.2k, 3m" oninput="calculateVI()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <div class="btn-container">
          <button class="btn" onclick="copyFormVI()">Copy Form</button>
          <button class="btn" onclick="addToHistoryVI()">Add v√†o l·ªãch s·ª≠</button>
        </div>
        <div class="log" id="logVI"></div>
      </div>
      <div class="container">
        <h3>L·ªãch s·ª≠ <button class="btn btn-red" style="float:right" onclick="clearHistoryVI()">X√≥a to√†n b·ªô l·ªãch s·ª≠</button></h3>
        <div class="historyVI" id="historyVI"></div>
        <h3>ƒê√£ xong</h3>
        <div id="doneListVI"></div>
      </div>
    </div>
  </div>

  <!-- PAGE: THB -->
  <div id="pageTHB" style="margin-top:60px;" hidden>
    <div id="appTHB" hidden style="display:none">
      <div class="container">
        <h2>Caculator ‚Äî Trang "T√™"</h2>
        <label>T·ª∑ gi√° THB:</label>
        <table>
          <thead><tr><th>Lo·∫°i</th><th>T·ª∑ gi√°</th></tr></thead>
          <tbody>
            <tr><td>THB / USDT</td><td><input type="number" id="rateTHB" placeholder="VD: 33.25" step="0.01" oninput="calculateTHB()" autocomplete="off" autocapitalize="off" spellcheck="false" /></td></tr>
          </tbody>
        </table>
        <label>T√™ (THB ‚ûù USDT):</label>
        <input type="text" id="thb_input" placeholder="VD: 300k, 1.5m " oninput="calculateTHB()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <label>U (USDT ‚ûù THB):</label>
        <input type="text" id="u_input_thb" placeholder="VD: 100, 2.5 (gi·ªØ s·ªë th·∫≠p ph√¢n)" oninput="calculateTHB()" autocomplete="off" autocapitalize="off" spellcheck="false">
        <div class="btn-container">
          <button class="btn" onclick="copyFormTHB()">Copy Form</button>
          <button class="btn" onclick="addToHistoryTHB()">Add v√†o l·ªãch s·ª≠</button>
        </div>
        <div class="log" id="logTHB"></div>
      </div>
      <div class="container">
        <h3>L·ªãch s·ª≠ <button class="btn btn-red" style="float:right" onclick="clearHistoryTHB()">X√≥a to√†n b·ªô l·ªãch s·ª≠</button></h3>
        <div class="historyTHB" id="historyTHB"></div>
        <h3>ƒê√£ xong</h3>
        <div id="doneListTHB"></div>
      </div>
    </div>
  </div>

  <!-- PAGE: ABA (layout gi·ªØ nguy√™n: #appABA l√† wrapper flex ch·ª©a 2 container) -->
  <div id="pageABA" style="margin-top:60px;" hidden>
    <div id="appABA" hidden style="display:none">
      <div class="container">
        <h2>Caculator ‚Äî Trang "ABA"</h2>
        <label>T·ª∑ gi√° ABA:</label>
        <table>
          <thead><tr><th>Lo·∫°i</th><th>T·ª∑ gi√°</th></tr></thead>
          <tbody>
            <tr>
              <td>USDT ‚áÑ ABA</td>
              <td><input type="text" id="rateABA4" placeholder="VD: 0.993" oninput="calculateABA()" autocomplete="off" autocapitalize="off" spellcheck="false" /></td>
            </tr>
          </tbody>
        </table>

        <label>S·ªë l∆∞·ª£ng:</label>
        <input type="text" id="amountABA" placeholder="VD: 10k, 100.125" oninput="calculateABA()" autocomplete="off" autocapitalize="off" spellcheck="false">

        <div class="round-toggle" style="margin:8px 0 4px; display:inline-flex; gap:8px; align-items:center;">
          <button id="roundIconABA" type="button" title="Ch·∫ø ƒë·ªô hi·ªán t·∫°i: l√†m tr√≤n xu·ªëng&#10;B·∫•m ƒë·ªÉ ƒë·ªïi (floor ‚Üí round ‚Üí ceil)" style="border:none;background:transparent;font-size:18px;cursor:pointer;line-height:1" data-mode="floor">üì±</button>
          <span id="roundModeLabelABA" style="font-weight:600;color:#003366">L√†m tr√≤n: <b>l√†m tr√≤n xu·ªëng</b></span>
        </div>

        <!-- B·∫£ng 1: USDT -> ABA -->
        <div class="btn-container">
          <button class="btn" onclick="copyLog('logABA_u2a')">Copy form USDT‚ÜíABA</button>
          <button class="btn" onclick="addToHistoryABA_U2A()">Add v√†o l·ªãch s·ª≠ (USDT‚ÜíABA)</button>
        </div>
        <div class="log" id="logABA_u2a"></div>

        <!-- B·∫£ng 2: ABA -> USDT -->
        <div class="btn-container">
          <button class="btn" onclick="copyLog('logABA_a2u')">Copy form ABA‚ÜíUSDT</button>
          <button class="btn" onclick="addToHistoryABA_A2U()">Add v√†o l·ªãch s·ª≠ (ABA‚ÜíUSDT)</button>
        </div>
        <div class="log" id="logABA_a2u"></div>
      </div>

      <div class="container">
        <h3>L·ªãch s·ª≠ <button class="btn btn-red" style="float:right" onclick="clearHistoryABA()">X√≥a to√†n b·ªô l·ªãch s·ª≠</button></h3>
        <div class="historyABA" id="historyABA"></div>
        <h3>ƒê√£ xong</h3>
        <div id="doneListABA"></div>
      </div>
    </div>
  </div>

  <!-- ===== JS ti·ªán √≠ch & t√≠nh to√°n ===== -->
  <script>
    // === Tiny toast helper ===
    function showToast(msg){
      const el=document.getElementById('toast'); if(!el) return;
      el.textContent = msg || 'ƒê√£ sao ch√©p';
      el.classList.add('show');
      clearTimeout(showToast._tmr);
      showToast._tmr = setTimeout(()=>el.classList.remove('show'), 2000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      try{ setupABRoundToggle(); }catch(e){}
      const sel = [
        '#rateU','#rateABA','#usdt_input','#aba_input','#idr_usdt_input','#idr_aba_input',
        '#rateVI','#vi_input','#u_input_vi',
        '#rateTHB','#thb_input','#u_input_thb',
        '#rateABA4','#amountABA',
        '#email','#password'
      ].join(',');
      document.querySelectorAll(sel).forEach(el=>{
        el.setAttribute('autocomplete','off');
        el.setAttribute('autocapitalize','off');
        el.setAttribute('spellcheck','false');
        if(!el.getAttribute('name')) el.setAttribute('name', el.id || ('field_'+Math.random().toString(36).slice(2)));
      });

      });

    // Clipboard fallback helper: d√πng Clipboard API n·∫øu c√≥, n·∫øu kh√¥ng r∆°i v·ªÅ textarea + execCommand
    function copyTextSafe(t){
      if(!t) return;
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(t).then(()=>showToast('ƒê√£ sao ch√©p'), ()=>fallback());
      } else { fallback(); }
      function fallback(){
        const ta=document.createElement('textarea'); ta.value=t;
        document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); showToast('ƒê√£ sao ch√©p'); }
        finally { ta.remove(); }
      }
    }

    // parseInput d√πng chung
    function parseInput(value){
      if(value===undefined||value===null) return NaN;
      let val=String(value).trim(); if(!val) return NaN;
      let mul=1; const suf=val.match(/([kmbKMB])\s*$/);
      if(suf){ const c=suf[1].toLowerCase(); if(c==='k') mul=1e3; else if(c==='m') mul=1e6; else if(c==='b') mul=1e9; val=val.replace(/([kmbKMB])\s*$/,'').trim(); }
      let s=val.replace(/\s/g,'');
      if(s.includes('.') && s.includes(',')){ s=s.replace(/\./g,'').replace(',', '.'); }
      else if(s.includes(',')){ const p=s.split(','); if(p.length===2 && p[1].length<=2) s=p[0]+'.'+p[1]; else s=s.replace(/,/g,''); }
      else if(s.includes('.')){ const p=s.split('.'); if(!(p.length===2 && p[1].length<=2)) s=s.replace(/\./g,''); }
      const num=parseFloat(s); if(isNaN(num)) return NaN;
      return num*mul;
    }

    // === ABA rounding toggle ===
    function labelForRoundModeABA(mode){
      if(mode==='ceil')  return 'l√†m tr√≤n l√™n';
      if(mode==='round') return 'l√†m tr√≤n chu·∫©n';
      return 'l√†m tr√≤n xu·ªëng';
    }
    function getRoundModeABA(){
      const ico = document.getElementById('roundIconABA');
      return ico ? (ico.dataset.mode || 'floor') : 'floor';
    }
    function setRoundModeABA(mode){
      const ico=document.getElementById('roundIconABA');
      const lbl=document.getElementById('roundModeLabelABA');
      const text = labelForRoundModeABA(mode);
      if(ico){ ico.dataset.mode = mode; ico.title = `Ch·∫ø ƒë·ªô hi·ªán t·∫°i: ${text}\nB·∫•m ƒë·ªÉ ƒë·ªïi (floor ‚Üí round ‚Üí ceil)`; }
      if(lbl){ lbl.innerHTML = 'L√†m tr√≤n: <b>' + text + '</b>'; }
    }
    function cycleRoundModeABA(){
      const order = ['floor','round','ceil'];
      const cur = getRoundModeABA();
      const next = order[(order.indexOf(cur)+1) % order.length];
      setRoundModeABA(next);
      if (typeof calculateABA === 'function') try { calculateABA(); } catch (e) {}
    }
    function roundByModeABA(n, mode){
      const x = Number(n)||0;
      if(mode==='ceil') return Math.ceil(x);
      if(mode==='round') return Math.round(x);
      return Math.floor(x);
    }
    function formatResultByMode(n){
      const mode = getRoundModeABA();
      if(mode==='round'){ return Number(n).toLocaleString('en-US',{ maximumFractionDigits: 2 }); }
      return roundByModeABA(n, mode).toLocaleString('en-US');
    }
    function setupABRoundToggle(){
      const ico = document.getElementById('roundIconABA');
      if(!ico) return;
      if(!ico.dataset.mode) ico.dataset.mode='floor';
      ico.addEventListener('click', cycleRoundModeABA);
      setRoundModeABA(getRoundModeABA());
    }

    /* ===== H√ÄM PARSE RI√äNG CHO ABA ===== */
    function parseRateABA(v){
      if(v===undefined||v===null) return NaN;
      let s=String(v).trim(); if(!s) return NaN;
      s=s.replace(/\s/g,'');
      if(s.includes('.') && s.includes(',')){ s=s.replace(/,/g,''); }
      else if(s.includes(',') && !s.includes('.')){ s=s.replace(',', '.'); }
      const n=parseFloat(s);
      return isNaN(n)?NaN:n;
    }
    function parseAmountABA(v){
      if(v===undefined||v===null) return NaN;
      let s=String(v).trim(); if(!s) return NaN;
      let mul=1; const suf=s.match(/([kmbKMB])\s*$/);
      if(suf){ const c=suf[1].toLowerCase(); if(c==='k') mul=1e3; else if(c==='m') mul=1e6; else if(c==='b') mul=1e9; s=s.replace(/([kmbKMB])\s*$/,'').trim(); }
      s=s.replace(/\s/g,'');
      if(s.includes('.') && s.includes(',')){ s=s.replace(/,/g,''); }
      else if(s.includes(',') && !s.includes('.')){ s=s.replace(',', '.'); }
      const n=parseFloat(s);
      return isNaN(n)?NaN:n*mul;
    }

    // ƒê·ªãnh d·∫°ng
    
    // ƒê·ªãnh d·∫°ng ‚Äî rebuilt clean to avoid any syntax glitches
    function formatCurrencyVN(n){
      if(!Number.isFinite(Number(n))) return '';
      const r = Number(n);
      // D√πng chu·∫©n ƒê·ª©c cho d·∫•u ph·∫©y th·∫≠p ph√¢n nh∆∞ VND/IDR m·∫´u g·ªëc
      return r.toLocaleString('de-DE').replace(/\./g, ',');
    }
    function formatSmartDecimal(n){
      const x = Number(n);
      if(!Number.isFinite(x)) return '';
      const q = Math.round((x + Number.EPSILON) * 100) / 100;
      const isInt = Math.abs(q - Math.round(q)) < 1e-9;
      return isInt
        ? Math.round(q).toLocaleString('en-US', { maximumFractionDigits: 0 })
        : q.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    // THB: formatter ƒë·ªôc l·∫≠p (kh√¥ng ph·ª• thu·ªôc mode ABA)
    function formatUSDT_THB(n){
      if(!Number.isFinite(Number(n))) return '';
      return Number(n).toLocaleString('en-US', { maximumFractionDigits: 2 });
    }
    function formatUSDT2(n){
      if(!Number.isFinite(Number(n))) return '';
      return Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    }
    function formatGeneric(n){
      if(!Number.isFinite(Number(n))) return '';
      return Number(n).toLocaleString('en-US',{maximumFractionDigits:8});
    }
    function formatIDR(n){ return Math.round(Number(n)).toLocaleString('de-DE').replace(/\./g,','); }
    function formatVNDInt(n){ return Math.round(Number(n)).toLocaleString('de-DE').replace(/\./g,','); }
    function formatRateTHB(n){ if(isNaN(n)) return ''; return Number(n).toFixed(2); }
    function formatTHBInt(n){ return Math.round(Number(n)).toLocaleString('en-US'); }

    function formatIDR(n){return Math.round(n).toLocaleString('de-DE').replace(/\./g,',');}
    function formatVNDInt(n){return Math.round(n).toLocaleString('de-DE').replace(/\./g,',');}
    function formatRateTHB(n){ if(isNaN(n)) return ''; return Number(n).toFixed(2); }
    function formatTHBInt(n){ return Math.round(Number(n)).toLocaleString('en-US'); }
    function getToday(){const d=new Date();return`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;}
    function getCurrentTime(){const d=new Date();return`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;}

    /* ========= IDR ========= */
    function getRates(){const rateU=parseFloat(document.getElementById('rateU').value);const rateABA=parseFloat(document.getElementById('rateABA').value);return{rateU,rateABA};}
    function calculate(){
      const {rateU,rateABA}=getRates();
      const usdtVal=document.getElementById('usdt_input').value;
      const abaVal=document.getElementById('aba_input').value;
      const idrUsdtRaw=document.getElementById('idr_usdt_input').value.trim();
      const idrAbaRaw=document.getElementById('idr_aba_input').value.trim();
      let log='', today=getToday();
      if(!rateU && !rateABA){document.getElementById("log").innerText="Kh√¥ng t√¨m th·∫•y t·ª∑ gi√°.";return;}
      if(usdtVal){const usdt=parseInput(usdtVal);if(!isNaN(usdt)&&rateU){const fee=usdt<5000?7:0;const total=usdt+fee;const idr=total*rateU;log+=`${today}\nUSDT: ${formatCurrencyVN(usdt)}${fee>0?` + ${fee} (fee)`:''} @ ${rateU}\nIDR: ${formatIDR(idr)}\n\n`;}}
      if(abaVal){const aba=parseInput(abaVal);if(!isNaN(aba)&&rateABA){const fee=aba<5000?10:0;const total=aba+fee;const idr=total*rateABA;log+=`${today}\nABA: ${formatCurrencyVN(aba)}${fee>0?` + ${fee} (fee)`:''} @ ${rateABA}\nIDR: ${formatIDR(idr)}\n\n`;}}
      if(idrUsdtRaw && !isNaN(parseFloat(idrUsdtRaw)) && rateU){const idr=parseFloat(idrUsdtRaw);const usdt=idr/rateU;log+=`${today}:\nIDR: ${formatIDR(idr)} @ ${rateU}\nUSDT: ${formatSmartDecimal(usdt)}\n\n`;}
      if(idrAbaRaw && !isNaN(parseFloat(idrAbaRaw)) && rateABA){const idr=parseFloat(idrAbaRaw);const aba=idr/rateABA;log+=`${today}:\nIDR: ${formatIDR(idr)} @ ${rateABA}\nABA: ${Math.round(aba).toLocaleString('en-US')}\n\n`;}
      document.getElementById("log").innerText=log||"Kh√¥ng c√≥ d·ªØ li·ªáu.";
    }
    function copyForm(){
      const t=document.getElementById("log").innerText;
      if(t.trim()) copyTextSafe(t);
    }

    function addToHistory(){
      // realtime x·ª≠ l√Ω ·ªü ph·∫ßn Firebase b√™n d∆∞·ªõi
    }

    /* ========= VI ========= */
    function calculateVI(){
      const rate=parseFloat(document.getElementById('rateVI').value);
      const viVal=document.getElementById('vi_input').value;
      const uVal=document.getElementById('u_input_vi').value;
      let log='', today=getToday();
      if(!rate){document.getElementById("logVI").innerText="Kh√¥ng t√¨m th·∫•y t·ª∑ gi√°.";return;}
      if(viVal){const vnd=parseInput(viVal);if(!isNaN(vnd)){const usdt=vnd/rate;log+=`${today}\nVND: ${formatVNDInt(vnd)} @ ${formatVNDInt(rate)}\nUSDT: ${formatSmartDecimal(usdt)}\n\n`;}}
      if(uVal){const usdt=parseInput(uVal);if(!isNaN(usdt)){const vnd=usdt*rate;log+=`${today}\nUSDT: ${formatCurrencyVN(usdt)} @ ${formatVNDInt(rate)}\nVND: ${formatVNDInt(vnd)}\n\n`;}}
      document.getElementById("logVI").innerText=log||"Kh√¥ng c√≥ d·ªØ li·ªáu.";
    }
    function copyFormVI(){ const t=document.getElementById("logVI").innerText; if(t.trim()) copyTextSafe(t); }

    /* ========= THB ========= */
    function calculateTHB(){
      const rate = parseFloat(document.getElementById('rateTHB').value);
      const thbVal = document.getElementById('thb_input').value;
      const uVal   = document.getElementById('u_input_thb').value;
      let log='', today=getToday();
      if(!rate){ document.getElementById("logTHB").innerText="Kh√¥ng t√¨m th·∫•y t·ª∑ gi√°."; return; }
      if(thbVal){
        const thb = parseInput(thbVal);
        if(!isNaN(thb)){
          const usdt = thb / rate;
          log += `${today}\nTHB: ${formatTHBInt(thb)} @ ${rate.toFixed(2)}\nUSDT: ${formatUSDT_THB(usdt)}\n\n`;
        }
      }
      if(uVal){
        const usdt = parseInput(uVal);
        if(!isNaN(usdt)){
          const thb = usdt * rate;
          log += `${today}\nUSDT: ${formatUSDT_THB(usdt)} @ ${rate.toFixed(2)}\nTHB: ${formatTHBInt(thb)}\n\n`;
        }
      }
      document.getElementById("logTHB").innerText = log || "Kh√¥ng c√≥ d·ªØ li·ªáu.";
    }
    function copyFormTHB(){ const t=document.getElementById("logTHB").innerText; if(t.trim()) copyTextSafe(t); }

    /* ========= ABA ========= */
    function calculateABA(){
      const rateStr = document.getElementById('rateABA4').value?.trim();
      const amtStr  = document.getElementById('amountABA').value?.trim();
      const rate = parseRateABA(rateStr);
      const amt  = parseAmountABA(amtStr);
      const today = getToday();
      let log1 = '', log2 = '';
      if(!rate){ document.getElementById("logABA_u2a").innerText="Kh√¥ng t√¨m th·∫•y t·ª∑ gi√°."; document.getElementById("logABA_a2u").innerText="Kh√¥ng t√¨m th·∫•y t·ª∑ gi√°."; return; }
      if(!amtStr){ document.getElementById("logABA_u2a").innerText=""; document.getElementById("logABA_a2u").innerText=""; return; }
      if(!isNaN(amt)){
        const aba = amt * rate; // USDT -> ABA
        log1 += `${today}\nUSDT: ${amtStr} @ ${rateStr}\nABA: ${formatResultByMode(aba)}\n\n`;
        const usdt = rate !== 0 ? (amt / rate) : 0; // ABA -> USDT
        log2 += `${today}\nABA: ${amtStr} @ ${rateStr}\nUSDT: ${formatResultByMode(usdt)}\n\n`;
      }
      document.getElementById("logABA_u2a").innerText = log1 || "";
      document.getElementById("logABA_a2u").innerText = log2 || "";
    }
    function copyLog(id){ const t=document.getElementById(id).innerText; if(t.trim()) copyTextSafe(t); }
  </script>

  <!-- ===== Firebase + Auth + Realtime ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDcyh6-XOKIS8GLCx24aAT5WPewc-Cu0RM",
      authDomain: "testsever1-1f5c9.firebaseapp.com",
      databaseURL: "https://testsever1-1f5c9-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "testsever1-1f5c9",
      storageBucket: "testsever1-1f5c9.firebasestorage.app",
      messagingSenderId: "587078219356",
      appId: "1:587078219356:web:5684169dcabbf85a0e9899"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);
    setPersistence(auth, browserLocalPersistence);

    const statusEl  = document.getElementById('syncStatus');
    const appEl     = document.getElementById('app');
    const appVIEl   = document.getElementById('appVI');
    const appTHBEl  = document.getElementById('appTHB');
    const appABAEl  = document.getElementById('appABA');
    const pageIDREl = document.getElementById('pageIDR');
    const pageVIEl  = document.getElementById('pageVI');
    const pageTHBEl = document.getElementById('pageTHB');
    const pageABAEl = document.getElementById('pageABA');
    const loginWrap = document.getElementById('loginWrap');
    const loginBtn  = document.getElementById('loginBtn');
    const loginMsg  = document.getElementById('loginMsg');
    const emailEl   = document.getElementById('email');
    const passEl    = document.getElementById('password');
    const logoutBtn = document.getElementById('logoutBtn');
    const topbarEl2 = document.getElementById('topbar');

    const roomId = location.hash?.slice(1) || "global";

    let unsubInputs=null,   unsubEntries=null;
    let unsubInputsVI=null, unsubEntriesVI=null;
    let unsubInputsTHB=null,unsubEntriesTHB=null;
    let unsubInputsABA=null,unsubEntriesABA=null;

    function showPage(which){
      if(!window.isAuthed) return;
      document.getElementById('tabIDR').classList.remove('active');
      document.getElementById('tabVI').classList.remove('active');
      document.getElementById('tabTHB').classList.remove('active');
      document.getElementById('tabABA').classList.remove('active');
      pageIDREl.hidden=true; pageVIEl.hidden=true; pageTHBEl.hidden=true; pageABAEl.hidden=true;
      if(which==='IDR'){ document.getElementById('tabIDR').classList.add('active'); pageIDREl.hidden=false; }
      else if(which==='VI'){ document.getElementById('tabVI').classList.add('active'); pageVIEl.hidden=false; }
      else if(which==='THB'){ document.getElementById('tabTHB').classList.add('active'); pageTHBEl.hidden=false; }
      else { document.getElementById('tabABA').classList.add('active'); pageABAEl.hidden=false; }
      document.body.setAttribute('data-ab-active', which==='ABA' ? '1' : '0');
    }
    document.getElementById('tabIDR').addEventListener('click',()=>showPage('IDR'));
    document.getElementById('tabVI').addEventListener('click',()=>showPage('VI'));
    document.getElementById('tabTHB').addEventListener('click',()=>showPage('THB'));
    document.getElementById('tabABA').addEventListener('click',()=>showPage('ABA'));

    loginBtn.onclick = async () => {
      loginMsg.textContent = "";
      try {
        if (!emailEl.value || !passEl.value) { loginMsg.textContent = "Nh·∫≠p email v√† m·∫≠t kh·∫©u."; return; }
        await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
      } catch (e) { loginMsg.textContent = e?.code?.replace("auth/","") || "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i"; }
    };
    logoutBtn.onclick = () => { const email=(auth&&auth.currentUser&&auth.currentUser.email)?` (${auth.currentUser.email})`:''; if(!confirm(`ƒêƒÉng xu·∫•t${email}?`)) return; signOut(auth); };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Show app
        window.isAuthed = true;
        loginWrap.style.display = "none";
        topbarEl2.hidden = false;

        pageIDREl.hidden=false; pageVIEl.hidden=true; pageTHBEl.hidden=true; pageABAEl.hidden=true;

        appEl.hidden=false;   appEl.style.display="flex";
        appVIEl.hidden=false; appVIEl.style.display="flex";
        appTHBEl.hidden=false;appTHBEl.style.display="flex";
        appABAEl.hidden=false;appABAEl.style.display="flex";
        logoutBtn.hidden=false;

        statusEl.classList.remove('sync-warn','sync-err'); statusEl.classList.add('sync-ok');
        statusEl.textContent = 'üîÑ'; statusEl.title = 'Realtime';

        attachRealtime_IDR(user);
        attachRealtime_VI(user);
        attachRealtime_THB(user);
        attachRealtime_ABA_inputs(user); // ABA: sync input
        attachRealtime_ABA_entries(user); // ABA: sync l·ªãch s·ª≠ + done
      } else {
        // Hide app
        window.isAuthed = false;
        topbarEl2.hidden = true;
        pageIDREl.hidden=true; pageVIEl.hidden=true; pageTHBEl.hidden=true; pageABAEl.hidden=true;
        appEl.hidden=true;     appEl.style.display="none";
        appVIEl.hidden=true;   appVIEl.style.display="none";
        appTHBEl.hidden=true;  appTHBEl.style.display="none";
        appABAEl.hidden=true;  appABAEl.style.display="none";
        logoutBtn.hidden=true;
        loginWrap.style.display="flex";

        statusEl.classList.remove('sync-ok','sync-err'); statusEl.classList.add('sync-warn');
        statusEl.textContent = 'üîÑ'; statusEl.title = 'Local only';

        detachRealtimeAll();
      }
    });

    function detachRealtimeAll(){
      [unsubEntries,unsubInputs,unsubEntriesVI,unsubInputsVI,unsubEntriesTHB,unsubInputsTHB,unsubInputsABA,unsubEntriesABA].forEach(fn=>{ if(typeof fn==='function') fn(); });
      unsubEntries=null;unsubInputs=null;unsubEntriesVI=null;unsubInputsVI=null;unsubEntriesTHB=null;unsubInputsTHB=null;unsubInputsABA=null;unsubEntriesABA=null;
    }

    /* ==== IDR realtime ==== */
    function attachRealtime_IDR(user){
      if (typeof unsubInputs === 'function') unsubInputs();
      if (typeof unsubEntries === 'function') unsubEntries();

      const inputsRef  = ref(db, `users/${user.uid}/rooms/${roomId}/inputs`);
      const entriesRef = ref(db, `users/${user.uid}/rooms/${roomId}/entries`);
      const ids=['rateU','rateABA','usdt_input','aba_input','idr_usdt_input','idr_aba_input'];
      let applying=false;
      function readInputs(){const o={};ids.forEach(id=>o[id]=document.getElementById(id)?.value||"");return o;}
      function saveInputs(){if(applying)return;set(inputsRef,readInputs());}
      ids.forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('input',()=>setTimeout(saveInputs,120));});
      unsubInputs = onValue(inputsRef,s=>{const v=s.val();if(!v)return;applying=true;ids.forEach(id=>{const el=document.getElementById(id);if(el&&typeof v[id]!=="undefined"&&el.value!==v[id])el.value=v[id]??"";});applying=false;if(typeof window.calculate==='function')window.calculate();});

      const historyEl=document.getElementById('history'); const doneEl=document.getElementById('doneList');
      function makeActiveEntry(key,e){
        const entry=document.createElement("div");entry.className="history-entry";entry.dataset.key=key;
        const header=document.createElement("div");header.className="entry-header";
        const name=document.createElement("input");name.type="text";name.placeholder="T√™n giao d·ªãch";name.value=e.name||"";name.autocomplete="off";name.spellcheck=false;name.autocapitalize="off";
        let tmr=null;
        name.addEventListener('input',()=>{clearTimeout(tmr);tmr=setTimeout(()=>{update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{name:name.value});},600);});
        name.addEventListener('blur',()=>{update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{name:name.value});});
        const date=document.createElement("span");date.textContent=e.date||"";
        const doneBtn=document.createElement("button");doneBtn.className="done-btn";doneBtn.textContent="Duy·ªát";
        const del=document.createElement("button");del.className="delete-btn";del.textContent="X√≥a";del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'m·ª•c n√†y'))).toString().slice(0,80); if(!confirm('X√≥a ‚Äú'+__label+'‚Äù?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`)) };
        doneBtn.onclick=()=>{ const __label=(name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'m·ª•c n√†y')).toString().slice(0,80); if(!confirm('Duy·ªát ‚Äú'+__label+'‚Äù?')) return; const lines=[...entry.querySelectorAll('.entry-content span')].map(s=>s.textContent);update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{status:'done',name:name.value||"",content:(e.content||lines.join("\n"))});};
        header.append(name,date,doneBtn,del);
        const content=document.createElement("div");content.className="entry-content";content.style.marginTop="8px";
        (e.lines||[]).forEach((line,i)=>{if(!line?.trim())return;const lc=document.createElement("div");const tick=document.createElement("input");tick.type="checkbox";tick.style.marginRight="8px";const span=document.createElement("span");span.textContent=line;tick.checked=!!(e.ticks&&e.ticks[i]);if(tick.checked)span.classList.add('highlighted');tick.addEventListener('change',()=>{const ticks=[];content.querySelectorAll('input[type="checkbox"]').forEach(ch=>ticks.push(ch.checked));update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{ticks});span.classList.toggle('highlighted',tick.checked);});lc.append(tick,span);content.appendChild(lc);});
        entry.append(header,content);historyEl.appendChild(entry);
      }
      function makeDoneEntry(key,e){
        const entry=document.createElement("div");entry.className="history-entry done-entry";entry.dataset.key=key;
        const header=document.createElement("div");header.className="entry-header";
        const nameInput=document.createElement("input");nameInput.type="text";nameInput.value=e.name||"";nameInput.style.fontWeight="bold";nameInput.style.color="#155724";nameInput.readOnly=true;nameInput.autocomplete="off";nameInput.spellcheck=false;nameInput.autocapitalize="off";
        const editBtn=document.createElement("button");editBtn.className="edit-btn";editBtn.textContent="Ch·ªânh s·ª≠a";
        const del=document.createElement("button");del.className="delete-btn";del.textContent="X√≥a";del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'m·ª•c n√†y'))).toString().slice(0,80); if(!confirm('X√≥a ‚Äú'+__label+'‚Äù?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`)) };
        header.append(nameInput,editBtn,del);
        const textarea=document.createElement("textarea");textarea.style.cssText="width:100%;margin-top:8px;font-family:monospace;font-size:14px;border-radius:6px;border:1px solid #ccc;resize:vertical;display:none;";textarea.value=e.content||(e.lines||[]).join("\n");
        const display=document.createElement("div");display.style.cssText="white-space:pre-wrap;color:#155724;font-weight:bold;margin-top:8px;";display.textContent=textarea.value;
        editBtn.onclick=()=>{const editing=textarea.style.display==="block";if(!editing){textarea.style.display="block";display.style.display="none";editBtn.textContent="L∆∞u";nameInput.readOnly=false;nameInput.focus();}else{textarea.style.display="none";display.style.display="block";display.textContent=textarea.value;editBtn.textContent="Ch·ªânh s·ª≠a";nameInput.readOnly=true;update(ref(db,`users/${user.uid}/rooms/${roomId}/entries/${key}`),{name:nameInput.value,content:textarea.value});}};
        entry.append(header,display,textarea);document.getElementById('doneList').appendChild(entry);
      }
      function renderAll(data){
        const historyEl=document.getElementById('history'); const doneEl=document.getElementById('doneList');
        historyEl.innerHTML="";doneEl.innerHTML="";
        const arr=data?Object.entries(data):[];
        arr.sort((a,b)=>(b[1]?.createdAt||0)-(a[1]?.createdAt||0));
        for(const[Key,e]of arr){(e.status==='done'?makeDoneEntry:makeActiveEntry)(Key,e);}
      }
      unsubEntries = onValue(entriesRef, s=>renderAll(s.val()));

      // bind push/clear cho IDR
      window.addToHistory=function(){
        const logText=document.getElementById("log").innerText.trim();
        if(!logText||logText==="Kh√¥ng c√≥ d·ªØ li·ªáu."||logText==="Kh√¥ng t√¨m th·∫•y t·ª∑ gi√°.")return;
        const lines=logText.split('\n').filter(l=>l.trim()!=="");
        push(ref(db,`users/${user.uid}/rooms/${roomId}/entries`),{name:"",date:`${getToday()} ${getCurrentTime()}`,lines,ticks:new Array(lines.length).fill(false),status:"active",createdAt:Date.now()});
        showToast('ƒê√£ th√™m v√†o l·ªãch s·ª≠');
      }
      window.clearHistory=function(){if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠?"))return;set(ref(db,`users/${user.uid}/rooms/${roomId}/entries`),null);}
    }

    /* ==== VI realtime ==== */
    function attachRealtime_VI(user){
      if (typeof unsubInputsVI === 'function') unsubInputsVI();
      if (typeof unsubEntriesVI === 'function') unsubEntriesVI();

      const inputsRef  = ref(db, `users/${user.uid}/rooms/${roomId}/inputsVI`);
      const entriesRef = ref(db, `users/${user.uid}/rooms/${roomId}/entriesVI`);
      const ids=['rateVI','vi_input','u_input_vi'];
      let applying=false;
      function readInputs(){const o={};ids.forEach(id=>o[id]=document.getElementById(id)?.value||"");return o;}
      function saveInputs(){if(applying)return;set(inputsRef,readInputs());}
      ids.forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('input',()=>setTimeout(saveInputs,120));});
      unsubInputsVI = onValue(inputsRef,s=>{const v=s.val();if(!v)return;applying=true;ids.forEach(id=>{const el=document.getElementById(id);if(el&&typeof v[id]!=="undefined"&&el.value!==v[id])el.value=v[id]??"";});applying=false;if(typeof window.calculateVI==='function')window.calculateVI();});

      const historyEl=document.getElementById('historyVI'); const doneEl=document.getElementById('doneListVI');
      function makeActiveEntry(key,e){
        const entry=document.createElement("div");entry.className="history-entry";entry.dataset.key=key;
        const header=document.createElement("div");header.className="entry-header";
        const name=document.createElement("input");name.type="text";name.placeholder="T√™n giao d·ªãch";name.value=e.name||"";name.autocomplete="off";name.spellcheck=false;name.autocapitalize="off";
        let tmr=null;
        name.addEventListener('input',()=>{clearTimeout(tmr);tmr=setTimeout(()=>{update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`),{name:name.value});},600);});
        name.addEventListener('blur',()=>{update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`),{name:name.value});});
        const date=document.createElement("span");date.textContent=e.date||"";
        const doneBtn=document.createElement("button");doneBtn.className="done-btn";doneBtn.textContent="Duy·ªát";
        const del=document.createElement("button");del.className="delete-btn";del.textContent="X√≥a";del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'m·ª•c n√†y'))).toString().slice(0,80); if(!confirm('X√≥a ‚Äú'+__label+'‚Äù?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`)) };
        doneBtn.onclick=()=>{ const __label=(name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'m·ª•c n√†y')).toString().slice(0,80); if(!confirm('Duy·ªát ‚Äú'+__label+'‚Äù?')) return; const lines=[...entry.querySelectorAll('.entry-content span')].map(s=>s.textContent);update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`),{status:'done',name:name.value||"",content:(e.content||lines.join("\n"))});};
        header.append(name,date,doneBtn,del);
        const content=document.createElement("div");content.className="entry-content";content.style.marginTop="8px";
        (e.lines||[]).forEach((line,i)=>{if(!line?.trim())return;const lc=document.createElement("div");const tick=document.createElement("input");tick.type="checkbox";tick.style.marginRight="8px";const span=document.createElement("span");span.textContent=line;tick.checked=!!(e.ticks&&e.ticks[i]);if(tick.checked)span.classList.add('highlighted');tick.addEventListener('change',()=>{const ticks=[];content.querySelectorAll('input[type="checkbox"]').forEach(ch=>ticks.push(ch.checked));update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`),{ticks});span.classList.toggle('highlighted',tick.checked);});lc.append(tick,span);content.appendChild(lc);});
        entry.append(header,content);historyEl.appendChild(entry);
      }
      function makeDoneEntry(key,e){
        const entry=document.createElement("div");entry.className="history-entry done-entry";entry.dataset.key=key;
        const header=document.createElement("div");header.className="entry-header";
        const nameInput=document.createElement("input");nameInput.type="text";nameInput.value=e.name||"";nameInput.style.fontWeight="bold";nameInput.style.color="#155724";nameInput.readOnly=true;nameInput.autocomplete="off";nameInput.spellcheck=false;nameInput.autocapitalize="off";
        const editBtn=document.createElement("button");editBtn.className="edit-btn";editBtn.textContent="Ch·ªânh s·ª≠a";
        const del=document.createElement("button");del.className="delete-btn";del.textContent="X√≥a";del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'m·ª•c n√†y'))).toString().slice(0,80); if(!confirm('X√≥a ‚Äú'+__label+'‚Äù?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`)) };
        header.append(nameInput,editBtn,del);
        const textarea=document.createElement("textarea");textarea.style.cssText="width:100%;margin-top:8px;font-family:monospace;font-size:14px;border-radius:6px;border:1px solid #ccc;resize:vertical;display:none;";textarea.value=e.content||(e.lines||[]).join("\n");
        const display=document.createElement("div");display.style.cssText="white-space:pre-wrap;color:#155724;font-weight:bold;margin-top:8px;";display.textContent=textarea.value;
        editBtn.onclick=()=>{const editing=textarea.style.display==="block";if(!editing){textarea.style.display="block";display.style.display="none";editBtn.textContent="L∆∞u";nameInput.readOnly=false;nameInput.focus();}else{textarea.style.display="none";display.style.display="block";display.textContent=textarea.value;editBtn.textContent="Ch·ªânh s·ª≠a";nameInput.readOnly=true;update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI/${key}`),{name:nameInput.value,content:textarea.value});}};
        entry.append(header,display,textarea);document.getElementById('doneListVI').appendChild(entry);
      }
      function renderAll(data){
        const historyEl=document.getElementById('historyVI'); const doneEl=document.getElementById('doneListVI');
        historyEl.innerHTML="";doneEl.innerHTML="";
        const arr=data?Object.entries(data):[];
        arr.sort((a,b)=>(b[1]?.createdAt||0)-(a[1]?.createdAt||0));
        for(const[Key,e]of arr){(e.status==='done'?makeDoneEntry:makeActiveEntry)(Key,e);}
      }
      unsubEntriesVI = onValue(entriesRef, s=>renderAll(s.val()));

      window.addToHistoryVI = function(){
        const logText=document.getElementById("logVI").innerText.trim();
        if(!logText||logText==="Kh√¥ng c√≥ d·ªØ li·ªáu."||logText==="Kh√¥ng t√¨m th·∫•y t·ª∑ gi√°.")return;
        const lines=logText.split('\n').filter(l=>l.trim()!=="");
        push(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI`),{name:"",date:`${getToday()} ${getCurrentTime()}`,lines,ticks:new Array(lines.length).fill(false),status:"active",createdAt:Date.now()});
        showToast('ƒê√£ th√™m v√†o l·ªãch s·ª≠');
      }
      window.clearHistoryVI = function(){ if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠?"))return; set(ref(db,`users/${user.uid}/rooms/${roomId}/entriesVI`),null); }
    }

    /* ==== THB realtime ==== */
    function attachRealtime_THB(user){
      if (typeof unsubInputsTHB === 'function') unsubInputsTHB();
      if (typeof unsubEntriesTHB === 'function') unsubEntriesTHB();

      const inputsRef  = ref(db, `users/${user.uid}/rooms/${roomId}/inputsTHB`);
      const entriesRef = ref(db, `users/${user.uid}/rooms/${roomId}/entriesTHB`);
      const ids=['rateTHB','thb_input','u_input_thb'];
      let applying=false;
      function readInputs(){const o={};ids.forEach(id=>o[id]=document.getElementById(id)?.value||"");return o;}
      function saveInputs(){if(applying)return;set(inputsRef,readInputs());}
      ids.forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('input',()=>setTimeout(saveInputs,120));});
      unsubInputsTHB = onValue(inputsRef,s=>{const v=s.val();if(!v)return;applying=true;ids.forEach(id=>{const el=document.getElementById(id);if(el&&typeof v[id]!=="undefined"&&el.value!==v[id])el.value=v[id]??"";});applying=false;if(typeof window.calculateTHB==='function')window.calculateTHB();});

      const historyEl=document.getElementById('historyTHB'); const doneEl=document.getElementById('doneListTHB');
      function makeActiveEntry(key,e){
        const entry=document.createElement("div");entry.className="history-entry";entry.dataset.key=key;
        const header=document.createElement("div");header.className="entry-header";
        const name=document.createElement("input");name.type="text";name.placeholder="T√™n giao d·ªãch";name.value=e.name||"";name.autocomplete="off";name.spellcheck=false;name.autocapitalize="off";
        let tmr=null;
        name.addEventListener('input',()=>{clearTimeout(tmr);tmr=setTimeout(()=>{update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`),{name:name.value});},600);});
        name.addEventListener('blur',()=>{update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`),{name:name.value});});
        const date=document.createElement("span");date.textContent=e.date||"";
        const doneBtn=document.createElement("button");doneBtn.className="done-btn";doneBtn.textContent="Duy·ªát";
        const del=document.createElement("button");del.className="delete-btn";del.textContent="X√≥a";del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'m·ª•c n√†y'))).toString().slice(0,80); if(!confirm('X√≥a ‚Äú'+__label+'‚Äù?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`)) };
        doneBtn.onclick=()=>{ const __label=(name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'m·ª•c n√†y')).toString().slice(0,80); if(!confirm('Duy·ªát ‚Äú'+__label+'‚Äù?')) return; const lines=[...entry.querySelectorAll('.entry-content span')].map(s=>s.textContent);update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`),{status:'done',name:name.value||"",content:(e.content||lines.join("\n"))});};
        header.append(name,date,doneBtn,del);
        const content=document.createElement("div");content.className="entry-content";content.style.marginTop="8px";
        (e.lines||[]).forEach((line,i)=>{if(!line?.trim())return;const lc=document.createElement("div");const tick=document.createElement("input");tick.type="checkbox";tick.style.marginRight="8px";const span=document.createElement("span");span.textContent=line;tick.checked=!!(e.ticks&&e.ticks[i]);if(tick.checked)span.classList.add('highlighted');tick.addEventListener('change',()=>{const ticks=[];content.querySelectorAll('input[type="checkbox"]').forEach(ch=>ticks.push(ch.checked));update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`),{ticks});span.classList.toggle('highlighted',tick.checked);});lc.append(tick,span);content.appendChild(lc);});
        entry.append(header,content);historyEl.appendChild(entry);
      }
      function makeDoneEntry(key,e){
        const entry=document.createElement("div");entry.className="history-entry done-entry";entry.dataset.key=key;
        const header=document.createElement("div");header.className="entry-header";
        const nameInput=document.createElement("input");nameInput.type="text";nameInput.value=e.name||"";nameInput.style.fontWeight="bold";nameInput.style.color="#155724";nameInput.readOnly=true;nameInput.autocomplete="off";nameInput.spellcheck=false;nameInput.autocapitalize="off";
        const editBtn=document.createElement("button");editBtn.className="edit-btn";editBtn.textContent="Ch·ªânh s·ª≠a";
        const del=document.createElement("button");del.className="delete-btn";del.textContent="X√≥a";del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'m·ª•c n√†y'))).toString().slice(0,80); if(!confirm('X√≥a ‚Äú'+__label+'‚Äù?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`)) };
        header.append(nameInput,editBtn,del);
        const textarea=document.createElement("textarea");textarea.style.cssText="width:100%;margin-top:8px;font-family:monospace;font-size:14px;border-radius:6px;border:1px solid #ccc;resize:vertical;display:none;";textarea.value=e.content||(e.lines||[]).join("\n");
        const display=document.createElement("div");display.style.cssText="white-space:pre-wrap;color:#155724;font-weight:bold;margin-top:8px;";display.textContent=textarea.value;
        editBtn.onclick=()=>{const editing=textarea.style.display==="block";if(!editing){textarea.style.display="block";display.style.display="none";editBtn.textContent="L∆∞u";nameInput.readOnly=false;nameInput.focus();}else{textarea.style.display="none";display.style.display="block";display.textContent=textarea.value;editBtn.textContent="Ch·ªânh s·ª≠a";nameInput.readOnly=true;update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB/${key}`),{name:nameInput.value,content:textarea.value});}};
        entry.append(header,display,textarea);document.getElementById('doneListTHB').appendChild(entry);
      }
      function renderAll(data){
        const historyEl=document.getElementById('historyTHB'); const doneEl=document.getElementById('doneListTHB');
        historyEl.innerHTML="";doneEl.innerHTML="";
        const arr=data?Object.entries(data):[];
        arr.sort((a,b)=>(b[1]?.createdAt||0)-(a[1]?.createdAt||0));
        for(const[Key,e]of arr){(e.status==='done'?makeDoneEntry:makeActiveEntry)(Key,e);}
      }
      unsubEntriesTHB = onValue(entriesRef, s=>renderAll(s.val()));

      window.addToHistoryTHB = function(){
        const logText=document.getElementById("logTHB").innerText.trim();
        if(!logText||logText==="Kh√¥ng c√≥ d·ªØ li·ªáu."||logText==="Kh√¥ng t√¨m th·∫•y t·ª∑ gi√°.")return;
        const lines=logText.split('\n').filter(l=>l.trim()!=="");
        push(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB`),{name:"",date:`${getToday()} ${getCurrentTime()}`,lines,ticks:new Array(lines.length).fill(false),status:"active",createdAt:Date.now()});
        showToast('ƒê√£ th√™m v√†o l·ªãch s·ª≠');
      }
      window.clearHistoryTHB = function(){ if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠?"))return; set(ref(db,`users/${user.uid}/rooms/${roomId}/entriesTHB`),null); }
    }

    /* ==== ABA realtime: inputs (gi·ªØ nguy√™n) ==== */
    function attachRealtime_ABA_inputs(user){
      if (typeof unsubInputsABA === 'function') unsubInputsABA();
      const inputsRef  = ref(db, `users/${user.uid}/rooms/${roomId}/inputsABA`);
      const ids=['rateABA4','amountABA'];
      let applying=false;
      function readInputs(){const o={};ids.forEach(id=>o[id]=document.getElementById(id)?.value||"");return o;}
      function saveInputs(){if(applying)return;set(inputsRef,readInputs());}
      ids.forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('input',()=>setTimeout(saveInputs,120));});
      unsubInputsABA = onValue(inputsRef,s=>{const v=s.val(); if(!v) return; applying=true; ids.forEach(id=>{const el=document.getElementById(id); if(el && typeof v[id]!=="undefined" && el.value!==v[id]) el.value=v[id]??"";}); applying=false; if(typeof window.calculateABA==='function') window.calculateABA();});
    }

    /* ==== ABA realtime (entries) ==== */
    function attachRealtime_ABA_entries(user){
      if (typeof unsubEntriesABA === 'function') unsubEntriesABA();

      const entriesRef = ref(db, `users/${user.uid}/rooms/${roomId}/entriesABA`);
      const historyEl=document.getElementById('historyABA');
      const doneEl=document.getElementById('doneListABA');

      function makeActiveEntry(key,e){
        const entry=document.createElement("div"); entry.className="history-entry"; entry.dataset.key=key;
        const header=document.createElement("div"); header.className="entry-header";
        const name=document.createElement("input"); name.type="text"; name.placeholder="T√™n giao d·ªãch"; name.value=e.name||""; name.autocomplete="off"; name.spellcheck=false; name.autocapitalize="off";
        let tmr=null;
        name.addEventListener('input',()=>{ clearTimeout(tmr); tmr=setTimeout(()=>{ update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`), {name:name.value}); },600); });
        name.addEventListener('blur',()=>{ update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`), {name:name.value}); });
        const date=document.createElement("span"); date.textContent=e.date||"";
        const doneBtn=document.createElement("button"); doneBtn.className="done-btn"; doneBtn.textContent="Duy·ªát";
        const del=document.createElement("button"); del.className="delete-btn"; del.textContent="X√≥a"; del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'m·ª•c n√†y'))).toString().slice(0,80); if(!confirm('X√≥a ‚Äú'+__label+'‚Äù?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`)) };
        doneBtn.onclick=()=>{ const __label=(name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'m·ª•c n√†y')).toString().slice(0,80); if(!confirm('Duy·ªát ‚Äú'+__label+'‚Äù?')) return;  const lines=[...entry.querySelectorAll('.entry-content span')].map(s=>s.textContent); update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`), {status:'done', name:name.value||"", content:(e.content||lines.join("\n"))}); };
        header.append(name,date,doneBtn,del);

        const content=document.createElement("div"); content.className="entry-content"; content.style.marginTop="8px";
        (e.lines||[]).forEach((line,i)=>{ 
          if(!line?.trim()) return;
          const lc=document.createElement("div");
          const tick=document.createElement("input"); tick.type="checkbox"; tick.style.marginRight="8px";
          const span=document.createElement("span"); span.textContent=line;
          tick.checked=!!(e.ticks&&e.ticks[i]); if(tick.checked) span.classList.add('highlighted');
          tick.addEventListener('change',()=>{ 
            const ticks=[]; content.querySelectorAll('input[type="checkbox"]').forEach(ch=>ticks.push(ch.checked));
            update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`), {ticks});
            span.classList.toggle('highlighted',tick.checked);
          });
          lc.append(tick,span); content.appendChild(lc);
        });
        entry.append(header,content); historyEl.appendChild(entry);
      }

      function makeDoneEntry(key,e){
        const entry=document.createElement("div"); entry.className="history-entry done-entry"; entry.dataset.key=key;
        const header=document.createElement("div"); header.className="entry-header";
        const nameInput=document.createElement("input"); nameInput.type="text"; nameInput.value=e.name||""; nameInput.style.fontWeight="bold"; nameInput.style.color="#155724"; nameInput.readOnly=true; nameInput.autocomplete="off"; nameInput.spellcheck=false; nameInput.autocapitalize="off";
        const editBtn=document.createElement("button"); editBtn.className="edit-btn"; editBtn.textContent="Ch·ªânh s·ª≠a";
        const del=document.createElement("button"); del.className="delete-btn"; del.textContent="X√≥a"; del.onclick=()=>{ const __label=(typeof nameInput!='undefined' && nameInput && nameInput.value ? nameInput.value : (typeof name!='undefined' && name && name.value ? name.value : ((e.lines&&e.lines[0])||e.content||e.date||'m·ª•c n√†y'))).toString().slice(0,80); if(!confirm('X√≥a ‚Äú'+__label+'‚Äù?')) return; remove(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`)) };
        header.append(nameInput,editBtn,del);
        const textarea=document.createElement("textarea"); textarea.style.cssText="width:100%;margin-top:8px;font-family:monospace;font-size:14px;border-radius:6px;border:1px solid #ccc;resize:vertical;display:none;"; textarea.value=e.content||(e.lines||[]).join("\n");
        const display=document.createElement("div"); display.style.cssText="white-space:pre-wrap;color:#155724;font-weight:bold;margin-top:8px;"; display.textContent=textarea.value;
        editBtn.onclick=()=>{ 
          const editing=textarea.style.display==="block";
          if(!editing){ textarea.style.display="block"; display.style.display="none"; editBtn.textContent="L∆∞u"; nameInput.readOnly=false; nameInput.focus(); }
          else{ textarea.style.display="none"; display.style.display="block"; display.textContent=textarea.value; editBtn.textContent="Ch·ªânh s·ª≠a"; nameInput.readOnly=true; update(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA/${key}`), {name:nameInput.value, content:textarea.value}); }
        };
        entry.append(header,display,textarea); doneEl.appendChild(entry);
      }

      function renderAll(data){
        historyEl.innerHTML=""; doneEl.innerHTML="";
        const arr=data?Object.entries(data):[];
        arr.sort((a,b)=>(b[1]?.createdAt||0)-(a[1]?.createdAt||0));
        for(const [k,e] of arr){ (e.status==='done'?makeDoneEntry:makeActiveEntry)(k,e); }
      }
      unsubEntriesABA = onValue(entriesRef, s=>renderAll(s.val()));

      window.addToHistoryABA_U2A = function(){
        const l=document.getElementById("logABA_u2a").innerText.trim(); if(!l) return;
        const lines=l.split('\n').filter(x=>x.trim()!=='');
        push(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA`), {name:"", date:`${getToday()} ${getCurrentTime()}`, lines, ticks:new Array(lines.length).fill(false), status:"active", createdAt:Date.now(), direction:'U2A'});
        showToast('ƒê√£ th√™m v√†o l·ªãch s·ª≠');
      };
      window.addToHistoryABA_A2U = function(){
        const l=document.getElementById("logABA_a2u").innerText.trim(); if(!l) return;
        const lines=l.split('\n').filter(x=>x.trim()!=='');
        push(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA`), {name:"", date:`${getToday()} ${getCurrentTime()}`, lines, ticks:new Array(lines.length).fill(false), status:"active", createdAt:Date.now(), direction:'A2U'});
        showToast('ƒê√£ th√™m v√†o l·ªãch s·ª≠');
      };
      window.clearHistoryABA = function(){ if(!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠?')) return; set(ref(db,`users/${user.uid}/rooms/${roomId}/entriesABA`), null); };
    }
  </script>
</body>
</html>
